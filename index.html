<!doctype html>
<html lang="es" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Aula Digital QR ‚Äî Direcci√≥n</title>
<style>
  :root{
    --bg1:#0b1020; --bg2:#0a0d18; --header-bg:#0b1020cc; --border:#1a2540;
    --card:#121a30; --text:#eaf3ff; --muted:#90a4b4; --accent:#6aa9ff;
    --ghost-bg:#18243d; --input-bg:#0b1326; --input-bd:#24345c;
    --ok:#0f4636; --mid:#4a3f16; --bad:#4a1c1c;
  }
  [data-theme="light"]{
    --bg1:#f6f8ff; --bg2:#eef2ff; --header-bg:#ffffffcc; --border:#dbe4ff;
    --card:#ffffff; --text:#0b1020; --muted:#5b6b7a; --accent:#2b6bff;
    --ghost-bg:#eef2ff; --input-bg:#ffffff; --input-bd:#c7d2fe;
    --ok:#dff7ef; --mid:#fff7da; --bad:#ffe3e3;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2))}
  header{position:sticky;top:0;z-index:10;background:var(--header-bg);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  header .wrap{max-width:1100px;margin:auto;padding:14px 16px;display:flex;gap:12px;align-items:center;color:var(--text)}
  header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
  header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  button,.chip{border:0;background:var(--accent);color:#07101f;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  button.ghost,.chip.ghost{background:var(--ghost-bg);color:var(--text)}
  button.small{padding:6px 10px;border-radius:8px;font-size:13px}
  .chip{padding:8px 12px;border-radius:999px;font-size:13px}
  .chip.active{background:var(--accent);color:#07101f}
  main{max-width:1100px;margin:auto;padding:16px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:0 0 12px 0}
  .controls .hint{margin-left:6px}
  .controls input[type="date"], .controls select{padding:8px 10px;border-radius:10px;border:1px solid var(--input-bd);background:var(--input-bg);color:var(--text)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:14px}
  @media (min-width:860px){.grid{grid-template-columns:repeat(3,minmax(280px,1fr))}}
  .tile{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;display:flex;gap:12px;cursor:pointer;transition:.2s transform,.2s border-color}
  .tile:hover{transform:translateY(-1px);border-color:#2a3b66}
  .tile .ico{min-width:52px;height:52px;border-radius:14px;background:var(--ghost-bg);display:grid;place-items:center;font-weight:800;color:var(--accent)}
  .tile .name{color:var(--text);font-size:18px;font-weight:800}
  .tile .sub{color:var(--muted);font-size:12px;line-height:1.3}
  .tile .state{margin-left:auto;font-size:12px;color:var(--muted)}
  .kpi{color:var(--muted);font-size:12px;margin-top:4px}
  .panel{margin-top:18px;background:color-mix(in oklab, var(--card) 90%, transparent);border:1px dashed #2a3b66;border-radius:18px;padding:16px}
  .panel h3{margin:0 0 10px 0;color:var(--text);font-size:16px}
  table.cfg{width:100%;border-collapse:separate;border-spacing:0 8px}
  table.cfg th, table.cfg td{font-size:14px;color:var(--text);vertical-align:top}
  table.cfg input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--input-bd);background:var(--input-bg);color:var(--text)}

  .gid-box-title{margin-top:6px;margin-bottom:4px;font-weight:700;color:var(--text);font-size:13px}
  .cfg-small{display:grid;grid-template-columns:1fr;gap:12px;margin-top:8px}
  @media (min-width:860px){ .cfg-small{grid-template-columns:repeat(2,minmax(280px,1fr));} }
  .gid-group{display:flex;flex-direction:column;gap:6px}
  .gid-label{font-size:12px;color:var(--muted)}
  .gid-input{font-size:16px;padding:12px 14px;border-radius:12px;border:2px solid var(--input-bd);background:var(--input-bg);color:var(--text);font-family:ui-monospace,Consolas,monospace}

  .view{display:none}.show{display:block}
  .list{margin-top:12px;background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden}
  .row{display:flex;gap:12px;align-items:center;padding:12px 14px;border-bottom:1px solid #19223f;color:var(--text);cursor:pointer}
  .row:last-child{border-bottom:0}
  .row .id{margin-left:auto;color:#9bb0c5;font-size:12px}
  .search{display:flex;gap:8px;margin:12px 0}
  .search input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--input-bd);background:var(--input-bg);color:var(--text)}

  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px}
  .pill.ok{background:var(--ok);color:#b6ffe1}
  .pill.warn{background:var(--mid);color:#ffeaa7}
  .pill.bad{background:var(--bad);color:#ffd3d3}

  .section{margin-top:14px;background:var(--card);border:1px solid var(--border);border-radius:18px;padding:12px}
  .section h4{margin:0 0 8px 0}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .grid-pct{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;margin-top:8px}
  @media (max-width:720px){ .grid-pct{grid-template-columns:repeat(2,minmax(140px,1fr));} }
  .card-mini{background:color-mix(in oklab, var(--ghost-bg) 80%, transparent);border:1px solid #203056;border-radius:12px;padding:8px 10px;color:var(--text)}
  .card-mini .t{font-size:12px;color:var(--muted)} .card-mini .v{font-weight:800;font-size:16px}

  /* Tarjeta resumen */
  .summary{display:grid;grid-template-columns:1fr 1fr;gap:12px;border-radius:18px;padding:12px;border:1px solid var(--border)}
  @media (max-width:720px){.summary{grid-template-columns:1fr}}
  .risk-low{background:color-mix(in oklab, var(--ok) 25%, transparent)}
  .risk-med{background:color-mix(in oklab, var(--mid) 25%, transparent)}
  .risk-high{background:color-mix(in oklab, var(--bad) 25%, transparent)}
  .summary .k{font-size:12px;color:var(--muted)} .summary .v{font-size:22px;font-weight:900}
  .spark{width:160px;height:40px}
  .info-row{display:flex;gap:12px;flex-wrap:wrap}
  .kv{display:flex;flex-direction:column;gap:2px}

  details{background:color-mix(in oklab, var(--ghost-bg) 80%, transparent);border:1px solid #203056;border-radius:12px;padding:8px 10px;margin:8px 0;color:var(--text)}
  summary{cursor:pointer;font-weight:700}
  .hint{color:var(--muted);font-size:12px}
  .empty{padding:12px;color:#9bb0c5}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .badge{background:color-mix(in oklab, var(--ghost-bg) 90%, transparent);border:1px solid #2a3b66;border-radius:999px;padding:6px 10px;color:#a7bed7;font-size:12px}

  /* Print: exportar PDF (solo la vista del alumno) */
  @media print{
    header, #view-home, #view-group .search, .chips, .hint, .btns-hide-print{display:none!important}
    body{background:white}
    main{max-width:none}
    .section{break-inside:avoid}
  }

  /* === P√≠ldoras (Faltantes / Tarde / A tiempo) ‚Äî alto contraste === */
  .pill{
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 14px;          /* antes 12 */
    font-weight: 800;         /* m√°s grueso */
    letter-spacing: .2px;
    border: 1px solid transparent;
  }
  /* Oscuro */
  [data-theme="dark"] .pill.ok   { background:#0a3b2f; color:#c9ffe9; border-color:#1ec48d; }
  [data-theme="dark"] .pill.warn { background:#3f360b; color:#ffe089; border-color:#ffce3a; }
  [data-theme="dark"] .pill.bad  { background:#3e0f0f; color:#ffd0d0; border-color:#ff7a7a; }
  /* Claro */
  [data-theme="light"] .pill.ok   { background:#c6f3e6; color:#084c3a; border-color:#0ea371; }
  [data-theme="light"] .pill.warn { background:#fff1b8; color:#8a5600; border-color:#f0b429; }
  [data-theme="light"] .pill.bad  { background:#ffd1d1; color:#8a0e0e; border-color:#ef4444; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üìò Aula Digital QR ‚Äî Faltantes por alumno</h1>
    <div class="right">
      <span class="badge">GViz + CSV ¬∑ s√≥lo lectura</span>
      <button id="btn-theme" class="ghost small" title="Cambiar tema">üåô Oscuro</button>
    </div>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="view-home" class="view show">
    <div class="controls">
      <span class="hint">Semana:</span>
      <button class="chip ghost" id="kpi-this">Esta semana</button>
      <button class="chip ghost" id="kpi-last">Semana pasada</button>
      <input type="date" id="kpi-date"/><button class="small ghost" id="kpi-go">Ir</button>
      <span class="hint">¬∑ D√≠as esperados:</span>
      <select id="kpi-days"><option value="5">5</option><option value="4">4</option>
        <option value="3">3</option><option value="2">2</option><option value="1">1</option>
        <option value="registered">D√≠as registrados</option></select>
      <span class="hint" id="kpi-week-label"></span>
    </div>

    <div class="grid" id="grupo-grid"></div>

    <div class="panel">
      <h3>‚öôÔ∏è Configurar hojas por grupo</h3>
      <table class="cfg" id="cfg-table"></table>
      <div class="btns-hide-print" style="display:flex;gap:8px;margin-top:8px">
        <button id="btn-save">Guardar</button>
        <button class="ghost" id="btn-clear">Borrar configuraci√≥n</button>
      </div>
      <p class="hint">üß© <b>Avanzado: GIDs</b> ‚Äî pega el n√∫mero tras <span class="mono">#gid=</span> en cada pesta√±a.<br/>
        <b>Nuevo (opcional):</b> puedes a√±adir GID para <span class="mono">Directorio</span> si tienes una pesta√±a con datos de contacto.</p>
    </div>
  </section>

  <!-- GRUPO -->
  <section id="view-group" class="view">
    <a class="btns-hide-print" href="#" id="back-to-home">‚Üê Volver</a>
    <h2 id="group-title" style="color:var(--text);margin:8px 0 2px 0"></h2>
    <div id="group-teacher" class="hint" style="margin-bottom:10px"></div>
    <div class="search btns-hide-print">
      <input id="q-alumno" placeholder="Buscar alumno por nombre o ID‚Ä¶"/>
      <div style="display:flex;gap:8px">
        <button id="btn-reload" class="ghost small">Recargar</button>
        <button id="btn-diagnose" class="ghost small">Diagn√≥stico</button>
      </div>
    </div>
    <div id="alumno-list" class="list"></div>
    <p class="hint">Lee: <span class="mono">Asistencia</span>, <span class="mono">Registro</span>, <span class="mono">Presets</span>. Fallback: <span class="mono">Puntos</span>.</p>
  </section>

  <!-- ALUMNO -->
  <section id="view-student" class="view">
    <a class="btns-hide-print" href="#" id="back-to-group">‚Üê Volver al grupo</a>
    <h2 id="student-title" style="color:var(--text);margin:8px 0 2px 0"></h2>
    <div id="student-meta" class="hint"></div>

    <!-- Tarjeta resumen + gr√°fico + sem√°foro -->
    <div id="summary-card" class="summary risk-low" style="margin-top:12px">
      <div>
        <div class="info-row">
          <div class="kv"><div class="k">Cumplimiento general</div><div id="sum-cump" class="v">‚Äì</div></div>
          <div class="kv"><div class="k">Asistencia 30 d√≠as</div><div id="sum-asis30" class="v">‚Äì</div></div>
          <div class="kv"><div class="k">Riesgo</div><div id="sum-risk" class="v">‚Äì</div></div>
        </div>
        <div class="info-row" style="margin-top:8px">
          <div class="kv"><div class="k">Asistencia semana actual</div><div id="sum-asiswk" class="v">‚Äì</div></div>
          <div class="kv"><div class="k">Comparado con grupo (cumpl./asis)</div><div id="sum-vsgrp" class="v">‚Äì</div></div>
        </div>
      </div>
      <div>
        <svg id="spark" class="spark" viewBox="0 0 160 40" preserveAspectRatio="none"></svg>
        <div class="hint" id="streak">Racha de inasistencias: ‚Äì</div>
      </div>
    </div>

    <div class="section">
      <h4>Resumen por trimestres</h4>
      <div id="resume-pills"></div>
      <div id="resume-pcts" class="grid-pct"></div>
    </div>

    <div class="section" id="momentos">
      <h4>Filtro por trimestre</h4>
      <div class="chips" id="moment-chips"></div>
      <p class="hint">Opciones: <span class="mono">Todo</span>, <span class="mono">M1</span>, <span class="mono">M2</span>, <span class="mono">M3</span>.</p>
    </div>

    <div class="section">
      <h4>Prioridad de regularizaci√≥n (faltantes m√°s urgentes)</h4>
      <div id="faltantes-urg"></div>
    </div>

    <div class="section">
      <h4>Faltantes (todos)</h4>
      <div id="faltantes"></div>
    </div>

    <div class="section">
      <h4>Entregados tarde</h4>
      <div id="tarde"></div>
    </div>

    <div class="section">
      <h4>Entregados (a tiempo)</h4>
      <div id="atiempo"></div>
    </div>

    <div class="section">
      <h4>Comparativa con el grupo</h4>
      <div id="cmp-grupo" class="grid-pct"></div>
      <p class="hint">Cumplimiento del grupo: entregas v√°lidas / (presets √ó n¬∫ alumnos). Asistencia del grupo: presentes / total de marcas de los √∫ltimos 30 d√≠as.</p>
    </div>

    <div class="section">
      <h4>Contacto del tutor (opcional)</h4>
      <div id="contacto"></div>
      <p class="hint">Se lee de una pesta√±a llamada <span class="mono">Directorio</span> (o por GID ‚ÄúDirectorio‚Äù). Columnas sugeridas: <span class="mono">Nombre | ID | Tutor | Tel√©fono | Email</span>.</p>
    </div>

    <div class="section">
      <h4>Acuerdos de la reuni√≥n</h4>
      <div style="display:grid;gap:8px">
        <input id="nota-resumen" placeholder="Resumen breve (qu√© se habl√≥)"/>
        <textarea id="nota-comp" rows="4" placeholder="Compromisos / acciones‚Ä¶"></textarea>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="nota-fecha" type="date" />
          <button id="btn-nota-save">Guardar</button>
          <button id="btn-nota-print" class="ghost">Exportar PDF</button>
        </div>
        <div class="hint">Se guarda localmente en este navegador.</div>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== TEMA ===== */
const THEME_KEY='audqr_theme';
const btnTheme=document.getElementById('btn-theme');
function applyTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem(THEME_KEY,t);btnTheme.textContent=t==='light'?'‚òÄÔ∏è Claro':'üåô Oscuro';}
(function(){applyTheme(localStorage.getItem(THEME_KEY)||'dark');})();
btnTheme.addEventListener('click',()=>{applyTheme((document.documentElement.getAttribute('data-theme')||'dark')==='dark'?'light':'dark');});

/* ===== UTIL ===== */
const GROUPS=[{code:'1A',label:'1ero A'},{code:'1B',label:'1ero B'},{code:'2A',label:'2do A'},{code:'2B',label:'2do B'},{code:'3A',label:'3ro A'},{code:'3B',label:'3ro B'},{code:'4A',label:'4to A'},{code:'4B',label:'4to B'},{code:'5A',label:'5to A'},{code:'5B',label:'5to B'},{code:'6A',label:'6to A'},{code:'6B',label:'6to B'}];
const LS_KEY='audqr_sheets_v10';
const KPI_PREF_KEY='audqr_kpi_pref_v1';
const stripDiacritics=s=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
const normText=s=>stripDiacritics(String(s||'').toLowerCase()).replace(/\s+/g,' ').trim();
const normTrabajo=s=>normText(s).replace(/^trabajo\s*/,''); const normPagina=s=>normText(s).replace(/^p\.?\s*/,'');
const pad=n=>String(n).padStart(2,'0'); const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function normDate(s){const t=String(s||'').trim(); if(!t)return''; const a=/^(\d{4}-\d{2}-\d{2})/.exec(t); if(a) return a[1];
  const b=/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/.exec(t); if(b){const d=new Date(+b[3],b[2]-1,+b[1]); return ymd(d);}
  const n=Number(t.replace(',','.')); if(!Number.isNaN(n)){const base=new Date(1899,11,30);return ymd(new Date(base.getTime()+n*86400000));}
  const d=new Date(t); if(!isNaN(+d)) return ymd(d); return'';}
function extractSheetId(s){if(!s) return ''; const m=String(s).match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); return m?m[1]:s.trim();}
function $(id){return document.getElementById(id);} function show(id){for(const el of document.querySelectorAll('.view')) el.classList.remove('show'); $(id).classList.add('show');}
function setHTML(id,html){$(id).innerHTML=html;}
function idxOfAnyLoose(cols,n){const f=x=>String(x||'').toLowerCase().replace(/[\s_]+/g,'').trim(); const lc=cols.map(c=>f(c)); for(const k of n){const i=lc.indexOf(f(k)); if(i>=0) return i;} return -1;}
const MOM_MAP={M1:'Trimestre 1',M2:'Trimestre 2',M3:'Trimestre 3'}; const fmtPct=(n,d)=> d>0 ? (Math.round((n/d)*1000)/10)+'%' : '‚Äì';
function mondayOf(d){const day=d.getDay(); const diff=(day===0?-6:1-day); const m=new Date(d); m.setDate(d.getDate()+diff); m.setHours(0,0,0,0); return m;}
function weekDates(d){const mon=mondayOf(d); const ys=[]; for(let i=0;i<5;i++){const t=new Date(mon); t.setDate(mon.getDate()+i); ys.push(ymd(t));} return ys;}

/* NUEVO: sets de semana (con y sin fin de semana) */
function getWeekSet(baseDate, includeWeekend=false){
  const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
  const day = d.getDay(); // 0=Dom, 1=Lun ‚Ä¶ 6=Sab
  const diffToMon = (day===0 ? -6 : 1 - day);
  const mon = new Date(d); mon.setDate(d.getDate()+diffToMon);
  const days = includeWeekend ? 7 : 5;
  const set = new Set();
  for(let i=0;i<days;i++){
    const t=new Date(mon); t.setDate(mon.getDate()+i);
    set.add(ymd(t));
  }
  return set;
}

/* Heur√≠sticas */
function findIdColumn(cols, rows){
  let i = idxOfAnyLoose(cols, ['ID','Id','id','Matricula','Matr√≠cula','CURP','No Lista','N Lista','No_Lista','NUA','Numero lista','N¬∞ Lista','Lista']);
  if (i >= 0) return i;
  const maxRows = Math.min(rows.length, 30); const score = new Array(cols.length).fill(0);
  for (let r = 0; r < maxRows; r++){ const row = rows[r] || [];
    for (let c = 0; c < cols.length; c++){ const v = String(row[c] ?? '').trim(); if (!v) continue;
      if (/^ID[A-Z0-9]{4,}$/i.test(v)) score[c]+=3; if (/^[A-Z0-9]{8,}$/.test(v)) score[c]+=1; if (v.length>=8 && v.length<=16) score[c]+=0.5; } }
  let best=-1,scoreBest=0; for(let c=0;c<score.length;c++){ if(score[c]>scoreBest){scoreBest=score[c]; best=c;} } return scoreBest>0?best:-1;
}
function getDateColumns(cols){return cols.map((c,i)=> normDate(String(c).trim()) ? i : -1).filter(i=>i>=0);}
function isPresent(v){const s=normText(v); if(!s) return false; if(!Number.isNaN(+s)) return (+s)>0; const s2=s.replace(/\s+/g,''); if(/^1\(100%?\)$/.test(s2)) return true;
  return ['x','‚úì','‚úî','p','presente','si','s√≠','s','ok','true','asistio','asisti√≥'].includes(s);}

/* ===== LECTORES ===== */
let __jsonpSeq=0;
function fetchGViz(sheetId,sheetName){
  return new Promise((resolve,reject)=>{
    const cb=`__gviz_cb_${Date.now()}_${++__jsonpSeq}`;
    const url=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?headers=1&tqx=out:json;responseHandler:${cb}&sheet=${encodeURIComponent(sheetName)}&ts=${Date.now()}`;
    const script=document.createElement('script'); let timeout=setTimeout(()=>{cleanup();reject(new Error(`Timeout GViz ${sheetName}`));},12000);
    function cleanup(){clearTimeout(timeout);delete window[cb];if(script.parentNode)script.parentNode.removeChild(script);}
    window[cb]=(json)=>{cleanup();try{
      let cols=(json.table?.cols||[]).map(c=>(c.label||'').toString().trim());
      let rows=(json.table?.rows||[]).map(r=>(r.c||[]).map(c=>c?.v ?? ''));
      const empt=cols.filter(c=>!c || /^[A-Z]$/.test(c)).length;
      if(empt>=Math.ceil(cols.length*0.5) && rows.length){const header=rows[0].map(v=>(v??'').toString().trim()); cols=header; rows=rows.slice(1);}
      resolve({cols,rows});
    }catch(e){reject(e);} };
    script.onerror=()=>{cleanup();reject(new Error(`Error de red GViz ${sheetName}`));};
    script.src=url;document.head.appendChild(script);
  });
}
async function fetchCSVByGid(sheetId,gid){
  const url=`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${encodeURIComponent(gid)}&ts=${Date.now()}`;
  const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error(`CSV ${gid} -> ${res.status}`);
  const text=await res.text(); const rows=parseCSV(text); const cols=(rows.shift()||[]).map(v=>(v??'').toString().trim()); return {cols,rows};
}
function parseCSV(text){
  const rows=[]; let row=[]; let cur=''; let inQ=false;
  for(let i=0;i<text.length;i++){const ch=text[i],nx=text[i+1];
    if(inQ){ if(ch==='"'&&nx==='"'){cur+='"';i++;} else if(ch==='"'){inQ=false;} else cur+=ch; }
    else { if(ch==='"'){inQ=true;} else if(ch===','){row.push(cur);cur='';}
      else if(ch==='\n'||ch==='\r'){ if(cur!==''||row.length){row.push(cur);rows.push(row);row=[];cur='';} }
      else cur+=ch; } }
  if(cur!==''||row.length){row.push(cur);rows.push(row);} return rows;
}

const NAME_CANDIDATES={
  asistencia:['Asistencia','asistencia','ASISTENCIA','Lista','Lista de asistencia','Lista de Asistencia'],
  registro:['Registro de trabajos','Registro','Trabajos','Historial','Registro trabajos','Registro_de_trabajos'],
  presets:['Presets','Cat√°logo','Catalogo','Tareas','Preset','Cat√°logo de trabajos'],
  puntos:['Puntos','puntos','PUNtos'],
  directorio:['Directorio','Contacto','Contactos','Tutor','Tutores']
};
async function loadSheetBlock(sheetId,blockKey,cfg){
  const names=NAME_CANDIDATES[blockKey]||[];
  for(const n of names){try{return await fetchGViz(sheetId,n);}catch(e){}}
  const gid=(cfg.gids||{})[blockKey]||''; if(gid) return await fetchCSVByGid(sheetId,gid);
  throw new Error(`No se encontr√≥ la pesta√±a "${blockKey}" y no hay GID configurado.`);
}

/* ===== HOME (config + KPIs) ===== */
let CFG={};
let KPI_PREF={mode:'this', date:'', exp:'5'};
function loadCfg(){
  try{CFG=JSON.parse(localStorage.getItem(LS_KEY)||'{}');}catch{CFG={};}
  for(const g of GROUPS){
    if(!CFG[g.code]) CFG[g.code]={sheetId:'',teacher:'',gids:{puntos:'',asistencia:'',registro:'',presets:'',directorio:''}};
    CFG[g.code].gids ||= {puntos:'',asistencia:'',registro:'',presets:'',directorio:''};
    CFG[g.code].teacher ||= '';
  }
}
function saveCfg(){localStorage.setItem(LS_KEY, JSON.stringify(CFG));}
function loadKpiPref(){ try{Object.assign(KPI_PREF, JSON.parse(localStorage.getItem(KPI_PREF_KEY)||'{}'));}catch{} }
function saveKpiPref(){ localStorage.setItem(KPI_PREF_KEY, JSON.stringify(KPI_PREF)); }

function mondayDatesLabel(base){const ys=weekDates(base); return `${ys[0]} ‚Üí ${ys[4]}`;}

/* NUEVO: KPI semanal con fallback (L-V ‚Üí L-D ‚Üí √∫ltimos 7 d√≠as) */
async function computeGroupWeekAttendance(sheetId, cfg, baseDate, expectedDaysMode){
  try{
    const {cols, rows}=await loadSheetBlock(sheetId,'asistencia',cfg);

    // 1) Lun‚ÄìVie
    let weekSet = getWeekSet(baseDate,false);
    let dateCols = getDateColumns(cols).filter(i => weekSet.has(normDate(cols[i])));

    // 2) si no hay columnas, Lun‚ÄìDom
    if(dateCols.length===0){
      weekSet = getWeekSet(baseDate,true);
      dateCols = getDateColumns(cols).filter(i => weekSet.has(normDate(cols[i])));
    }

    // 3) si sigue vac√≠o, √∫ltimos 7 d√≠as
    if(dateCols.length===0){
      const end = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
      const start = new Date(end); start.setDate(end.getDate()-6);
      const y0 = ymd(start), y1 = ymd(end);
      dateCols = getDateColumns(cols).filter(i=>{
        const d = normDate(cols[i]); return d && d>=y0 && d<=y1;
      });
    }

    const students = rows.length;
    let present = 0;
    for(const r of rows){ for(const i of dateCols){ if(isPresent(r[i])) present++; } }

    const regDays = dateCols.length;
    const expDays = (expectedDaysMode==='registered') ? regDays
                   : Math.max(1, Math.min(5, +expectedDaysMode||5));
    const expectedFull = students * (expDays || 1);
    const pct = expectedFull>0 ? Math.round((present/expectedFull)*1000)/10 : 0;

    return {present, regDays, expected: expectedFull, pct};
  }catch{return null;}
}

function renderHome(){
  $('kpi-this').classList.toggle('active',KPI_PREF.mode==='this');
  $('kpi-last').classList.toggle('active',KPI_PREF.mode==='last');
  $('kpi-date').value=KPI_PREF.date||''; $('kpi-days').value=KPI_PREF.exp;
  const base=(KPI_PREF.mode==='last')?new Date(Date.now()-7*864e5):(KPI_PREF.mode==='date'&&KPI_PREF.date?new Date(KPI_PREF.date+'T00:00'):new Date());
  $('kpi-week-label').textContent='('+mondayDatesLabel(base)+')';

  const grid=GROUPS.map(g=>{
    const ok=!!CFG[g.code].sheetId; const teacher=CFG[g.code].teacher||'(sin asignar)';
    return `<div class="tile" data-code="${g.code}">
      <div class="ico">${g.code}</div>
      <div>
        <div class="name">${g.label}</div>
        <div class="sub">Docente: <b>${teacher}</b><br>${ok?'Hoja configurada':'Sin hoja configurada'}</div>
        ${ok? `<div class="kpi" id="kpi-${g.code}">Asistencia semana: calculando‚Ä¶</div>`:''}
      </div>
      <div class="state">${ok?'‚úÖ':'‚ö†Ô∏è'}</div>
    </div>`;}).join('');
  setHTML('grupo-grid',grid);

  for(const el of document.querySelectorAll('.tile')){
    el.addEventListener('click',()=>{const code=el.getAttribute('data-code'); if(!CFG[code].sheetId){alert('Configura este grupo y guarda.');return;} openGroup(code);});
  }
  refreshAllKPIs();
}
async function refreshAllKPIs(){
  const base=(KPI_PREF.mode==='last')?new Date(Date.now()-7*864e5):(KPI_PREF.mode==='date'&&KPI_PREF.date?new Date(KPI_PREF.date+'T00:00'):new Date());
  for(const g of GROUPS){
    const cfg=CFG[g.code]; if(!cfg.sheetId) continue;
    const el=$('kpi-'+g.code); if(!el) continue; el.textContent='Asistencia semana: calculando‚Ä¶';
    const k=await computeGroupWeekAttendance(cfg.sheetId,cfg,base,KPI_PREF.exp);
    el.textContent= k? `Asistencia semana: ${k.present}/${k.expected} (${(k.pct||0).toFixed(1)}%) ¬∑ d√≠as ${k.regDays}/${KPI_PREF.exp==='registered'?k.regDays:KPI_PREF.exp}` : 'Asistencia semana: no disponible';
  }
}

/* ===== CONFIG TABLE ===== */
function buildCfgTable(){
  const header=`<thead><tr><th style="text-align:left;width:110px">Grupo</th>
    <th style="text-align:left">URL o ID de la hoja</th><th style="text-align:left;width:260px">Docente</th></tr></thead>`;
  const rows=GROUPS.map(g=>{
    const cfg=CFG[g.code];
    return `<tr>
      <td>
        <b>${g.label}</b>
        <div class="gid-box-title">üß© Avanzado: GIDs por pesta√±a</div>
        <div class="cfg-small">
          <label class="gid-group"><span class="gid-label">1) <b>Puntos</b> ‚Äî #gid=‚Ä¶</span>
            <input id="gid-${g.code}-puntos" class="gid-input" value="${cfg.gids.puntos||''}"></label>
          <label class="gid-group"><span class="gid-label">2) <b>Asistencia</b> ‚Äî #gid=‚Ä¶</span>
            <input id="gid-${g.code}-asistencia" class="gid-input" value="${cfg.gids.asistencia||''}"></label>
          <label class="gid-group"><span class="gid-label">3) <b>Registro</b> ‚Äî #gid=‚Ä¶</span>
            <input id="gid-${g.code}-registro" class="gid-input" value="${cfg.gids.registro||''}"></label>
          <label class="gid-group"><span class="gid-label">4) <b>Presets</b> ‚Äî #gid=‚Ä¶</span>
            <input id="gid-${g.code}-presets" class="gid-input" value="${cfg.gids.presets||''}"></label>
          <label class="gid-group"><span class="gid-label">5) <b>Directorio</b> (opcional) ‚Äî #gid=‚Ä¶</span>
            <input id="gid-${g.code}-directorio" class="gid-input" value="${cfg.gids.directorio||''}"></label>
        </div>
      </td>
      <td><input id="in-${g.code}-sheet" placeholder="URL o ID‚Ä¶" value="${cfg.sheetId ? 'https://docs.google.com/spreadsheets/d/'+cfg.sheetId+'/edit' : ''}"/></td>
      <td><input id="in-${g.code}-teacher" placeholder="Nombre del docente" value="${cfg.teacher||''}"/></td>
    </tr>`;}).join('');
  setHTML('cfg-table',`${header}<tbody>${rows}</tbody>`);
}
$('btn-save').addEventListener('click',()=>{
  for(const g of GROUPS){
    const vs=$('in-'+g.code+'-sheet').value.trim(), vt=$('in-'+g.code+'-teacher').value.trim();
    CFG[g.code].sheetId=extractSheetId(vs); CFG[g.code].teacher=vt;
    CFG[g.code].gids={puntos:$('gid-'+g.code+'-puntos').value.trim(), asistencia:$('gid-'+g.code+'-asistencia').value.trim(),
      registro:$('gid-'+g.code+'-registro').value.trim(), presets:$('gid-'+g.code+'-presets').value.trim(),
      directorio:$('gid-'+g.code}-directorio').value?.trim?.() || $('gid-'+g.code+'-directorio').value.trim()};
  }
  saveCfg(); buildCfgTable(); renderHome(); alert('Configuraci√≥n guardada.');
});
$('btn-clear').addEventListener('click',()=>{ if(confirm('¬øBorrar configuraci√≥n?')){localStorage.removeItem(LS_KEY);loadCfg();buildCfgTable();renderHome();} });

/* ===== GRUPO / ALUMNOS ===== */
let CURRENT_GROUP=null, CURRENT_SHEET=null, CURRENT_CFG=null; let ALUMNOS=[];
async function loadAlumnos(sheetId,cfg){
  try{
    const {cols,rows}=await loadSheetBlock(sheetId,'asistencia',cfg);
    const iNombre=idxOfAnyLoose(cols,['Nombre','Nombre del alumno','Alumno','Apellidos y Nombres','Nombre y Apellido']);
    const iId=findIdColumn(cols,rows);
    const list=rows.map(r=>({nombre:String(r[iNombre]||'').trim(), id:(iId>=0? String(r[iId]||'').trim() : '')})).filter(x=>x.nombre||x.id);
    if(list.length===0) throw new Error('Asistencia vac√≠a'); return list;
  }catch{
    const {cols,rows}=await loadSheetBlock(sheetId,'puntos',cfg);
    const iNombre=idxOfAnyLoose(cols,['Nombre','Nombre del alumno','Alumno','Apellidos y Nombres','Nombre y Apellido']);
    const iId=findIdColumn(cols,rows);
    return rows.map(r=>({nombre:String(r[iNombre]||'').trim(), id:(iId>=0? String(r[iId]||'').trim() : '')})).filter(x=>x.nombre||x.id);
  }
}
function renderAlumnos(){
  const q=normText($('q-alumno').value);
  const items=ALUMNOS.filter(a=>!q||normText(a.nombre).includes(q)||normText(a.id).includes(q)).sort((a,b)=>a.nombre.localeCompare(b.nombre,'es'));
  if(items.length===0){setHTML('alumno-list','<div class="empty">Sin resultados.</div>');return;}
  setHTML('alumno-list',items.map(a=>`<div class="row" data-id="${a.id}" data-n="${encodeURIComponent(a.nombre)}"><div>${a.nombre||'(sin nombre)'}</div><div class="id">${a.id||''}</div></div>`).join(''));
  for(const el of document.querySelectorAll('#alumno-list .row')){ el.addEventListener('click',()=>{openStudent(CURRENT_SHEET, CURRENT_CFG, {id:el.getAttribute('data-id'), nombre:decodeURIComponent(el.getAttribute('data-n'))});}); }
}
function openGroup(code){
  CURRENT_GROUP=code; CURRENT_CFG=CFG[code]; CURRENT_SHEET=CURRENT_CFG.sheetId;
  const label=GROUPS.find(g=>g.code===code).label;
  $('group-title').textContent=`Grupo: ${label}`; $('group-teacher').textContent=`Docente: ${CURRENT_CFG.teacher||'(sin asignar)'}`;
  $('q-alumno').value=''; show('view-group');
  $('back-to-home').onclick=e=>{e.preventDefault();show('view-home');};
  $('btn-reload').onclick=async()=>{ALUMNOS=await loadAlumnos(CURRENT_SHEET, CURRENT_CFG); renderAlumnos();};
  $('q-alumno').oninput=renderAlumnos; $('btn-diagnose').onclick=()=>diagnoseSheet(CURRENT_SHEET, CURRENT_CFG);
  (async()=>{ setHTML('alumno-list','<div class="empty">Cargando alumnos‚Ä¶</div>');
    try{ALUMNOS=await loadAlumnos(CURRENT_SHEET, CURRENT_CFG); renderAlumnos();}catch(e){setHTML('alumno-list',`<div class="empty">No se pudo cargar.<br><span class="hint">${e.message}</span></div>`);} })();
}

/* ===== PARSERS ===== */
function parseRegistro(cols,rows){
  const idx=names=>idxOfAnyLoose(cols,names);
  const iUIDE=idx(['UID_ENTREGA','UID ENTREGA','UID Entrega','uid_entrega','uidentrega']);
  const iUIDP=idx(['UID_PRESET','UID PRESET','UID Preset','uid_preset','uidpreset']);
  const iF=idx(['Fecha']), iFO=idx(['Fecha objetivo','Fecha Objetivo','Fecha_objetivo']), iH=idx(['Hora']);
  const iID=idx(['ID','Id','id','Matricula','Matr√≠cula','CURP','No Lista','N Lista','No_Lista','NUA']);
  const iN=idx(['Nombre','Nombre del alumno','Alumno','Apellidos y Nombres','Nombre y Apellido']);
  const iM=idx(['Materia']); const iNum=idx(['N¬∫ Trabajo','No. Trabajo','N¬∫','No','Numero','N√∫mero','NumTrabajo']);
  const iOri=idx(['Origen']); const iPag=idx(['P√°gina','Pagina']); const iPts=idx(['Puntos']);
  const iAtr=idx(['Atraso (d√≠as)','Atraso','Retraso','Atraso_dias']); const iMom=idx(['Momento']);
  const iNomT=idx(['NombreTrabajo','Nombre Trabajo','Nombre_trabajo']); const iOrgS=idx(['OrigenScan','Origen Scan']); const iNot=idx(['Notas']);
  return rows.map(r=>{
    const fecha=String(r[iF]??'').trim(); const fo=String((iFO>=0?r[iFO]:'')??'').trim()||fecha;
    const atraso=(()=>{if(iAtr>=0 && r[iAtr]!=='' && r[iAtr]!=null) return +r[iAtr]||0;
      const d=new Date(fecha), o=new Date(fo); if(isNaN(+d)||isNaN(+o)) return 0; return Math.max(0, Math.round((d-o)/86400000));})();
    return { uidEntrega:String((iUIDE>=0?r[iUIDE]:'')??'').trim(), uidPreset:String((iUIDP>=0?r[iUIDP]:'')??'').trim(),
      fecha, fechaObjetivo:fo, hora:String((iH>=0?r[iH]:'')??'').trim(), id:String((iID>=0?r[iID]:'')??'').trim(),
      nombre:String((iN>=0?r[iN]:'')??'').trim(), materia:String((iM>=0?r[iM]:'')??'').trim(), numero:String((iNum>=0?r[iNum]:'')??'').trim(),
      origen:String((iOri>=0?r[iOri]:'')??'').trim(), pagina:String((iPag>=0?r[iPag]:'')??'').trim(),
      puntos:+((iPts>=0?r[iPts]:0)??0)||0, atrasoDias:atraso, momento:String((iMom>=0?r[iMom]:'')??'').trim(),
      nombreTrabajo:String((iNomT>=0?r[iNomT]:'')??'').trim(), origenScan:String((iOrgS>=0?r[iOrgS]:'')??'').trim(), notas:String((iNot>=0?r[iNot]:'')??'').trim() };
  });
}
function parsePresets(cols,rows){
  const idx=names=>idxOfAnyLoose(cols,names);
  const iUID=idx(['UID_PRESET','UID PRESET','UID Preset','uid_preset','uidpreset']);
  const iFO=idx(['Fecha objetivo','Fecha Objetivo','Fecha_objetivo']); const iMom=idx(['Momento']); const iMat=idx(['Materia']);
  const iNum=idx(['N¬∫ Trabajo','No. Trabajo','N¬∫','No','Numero','N√∫mero','NumTrabajo']); const iOri=idx(['Origen']); const iPag=idx(['P√°gina','Pagina']);
  const iNom=idx(['NombreTrabajo','Nombre Trabajo','Nombre_trabajo']);
  return rows.map(r=>({uid:String((iUID>=0?r[iUID]:'')??'').trim(), fechaObjetivo:String((iFO>=0?r[iFO]:'')??'').trim(), momento:String((iMom>=0?r[iMom]:'')??'').trim(),
    materia:String((iMat>=0?r[iMat]:'')??'').trim(), numero:String((iNum>=0?r[iNum]:'')??'').trim(), origen:String((iOri>=0?r[iOri]:'')??'').trim(),
    pagina:String((iPag>=0?r[iPag]:'')??'').trim(), nombreTrabajo:String((iNom>=0?r[iNom]:'')??'').trim()})).filter(p=>p.uid);
}
function parseDirectorio(cols,rows){
  const iNom=idxOfAnyLoose(cols,['Nombre','Alumno','Nombre del alumno']);
  const iId =idxOfAnyLoose(cols,['ID','Id','id','Matricula','Matr√≠cula','CURP','No Lista','Lista']);
  const iTut=idxOfAnyLoose(cols,['Tutor','Padre/Madre/Tutor','Acudiente']);
  const iTel=idxOfAnyLoose(cols,['Tel√©fono','Telefono','Tel']);
  const iMail=idxOfAnyLoose(cols,['Email','Correo','e-mail','Mail']);
  const map=new Map();
  for(const r of rows){
    const obj={nombre:String(r[iNom]||'').trim(), id:String(r[iId]||'').trim(), tutor:String(r[iTut]||'').trim(), tel:String(r[iTel]||'').trim(), mail:String(r[iMail]||'').trim()};
    if(obj.id) map.set(normText(obj.id), obj);
    if(obj.nombre) map.set(normText(obj.nombre), Object.assign({},obj,{_byName:true}));
  }
  return map;
}

/* ===== ASISTENCIA C√ÅLCULOS ===== */
function asistenciaRangeForStudent(cols,rows,ref,start,end){ // fechas YYYY-MM-DD
  const iId=findIdColumn(cols,rows); const iNom=idxOfAnyLoose(cols,['Nombre','Nombre del alumno','Alumno','Apellidos y Nombres','Nombre y Apellido']);
  let row=null; if(iId>=0 && ref.id) row=rows.find(r=>normText(r[iId])===normText(ref.id)); if(!row && iNom>=0 && ref.nombre) row=rows.find(r=>normText(r[iNom])===normText(ref.nombre));
  if(!row) return {present:0,total:0};
  const dateCols=getDateColumns(cols).filter(i=>{const d=normDate(cols[i]); return d && d>=start && d<=end;});
  let present=0,total=0; for(const i of dateCols){ const v=row[i]; if(v!==null && v!==''){ total++; if(isPresent(v)) present++; } }
  return {present,total};
}
function asistenciaRangeForGroup(cols,rows,start,end){
  const dateCols=getDateColumns(cols).filter(i=>{const d=normDate(cols[i]); return d && d>=start && d<=end;});
  let present=0,total=0; for(const r of rows){ for(const i of dateCols){ const v=r[i]; if(v!==null && v!==''){ total++; if(isPresent(v)) present++; } } }
  return {present,total};
}
function last4WeeksSeries(cols,rows,ref){
  const now=new Date(); const series=[]; for(let w=3; w>=0; w--){
    const base=new Date(now.getFullYear(),now.getMonth(),now.getDate()-7*w);
    const ds=weekDates(base); const a=asistenciaRangeForStudent(cols,rows,ref,ds[0],ds[4]); const pct=a.total?Math.round((a.present/a.total)*100):0; series.push(pct); }
  return series;
}
function rachaInasistencias(cols,rows,ref){
  const iId=findIdColumn(cols,rows); const iNom=idxOfAnyLoose(cols,['Nombre','Nombre del alumno','Alumno']); let row=null;
  if(iId>=0 && ref.id) row=rows.find(r=>normText(r[iId])===normText(ref.id)); if(!row && iNom>=0 && ref.nombre) row=rows.find(r=>normText(r[iNom])===normText(ref.nombre));
  if(!row) return 0; const dcs=getDateColumns(cols).map(i=>({i,d:normDate(cols[i])})).filter(x=>x.d && x.d<=ymd(new Date())).sort((a,b)=>b.d.localeCompare(a.d));
  let streak=0; for(const {i} of dcs){const v=row[i]; if(v===null||v==='') continue; if(isPresent(v)) break; streak++;} return streak;
}
function drawSpark(elId,values){
  const w=160,h=40; const max=100,min=0; const step=w/(values.length-1 || 1);
  const y=v=> h - ( (v-min)/(max-min) )*h;
  $(elId).innerHTML=`<polyline points="${values.map((v,i)=>`${i*step},${y(v)}`).join(' ')}" fill="none" stroke="currentColor" stroke-width="2" opacity="0.8"/>${values.map((v,i)=>`<circle cx="${i*step}" cy="${y(v)}" r="2"></circle>`).join('')}`;
}

/* ===== ALUMNO: ESTADO / RIESGO ===== */
let STUDENT_DATA={faltantes:[],tarde:[],aTiempo:[],alumno:null};
let MOM_FILTER='ALL';
const MOM_MAP2={M1:'Trimestre 1',M2:'Trimestre 2',M3:'Trimestre 3'};
function setMomentChips(){ const el=$('moment-chips'); const opts=[{v:'ALL',label:'Todo'},{v:'M1',label:'M1'},{v:'M2',label:'M2'},{v:'M3',label:'M3'}];
  el.innerHTML=opts.map(o=>`<button class="chip ${MOM_FILTER===o.v?'active':''}" data-v="${o.v}">${o.label}</button>`).join('');
  for(const b of el.querySelectorAll('.chip')) b.addEventListener('click',()=>{MOM_FILTER=b.getAttribute('data-v'); setMomentChips(); renderStudentSections();});
}
function applyMomentFilter(list){ if(MOM_FILTER==='ALL') return list; const t=MOM_FILTER; return list.filter(x=>String(x.momento||'').toUpperCase()===t); }
function buildPctCards(){
  const all=[...STUDENT_DATA.faltantes, ...STUDENT_DATA.tarde, ...STUDENT_DATA.aTiempo];
  const delivered=STUDENT_DATA.tarde.length+STUDENT_DATA.aTiempo.length;
  const make=tag=>{ if(tag==='ALL'){return {title:'General',pct:fmtPct(delivered,all.length),frac:`${delivered}/${all.length}`};}
    const mm=tag; const tot=all.filter(x=>String(x.momento||'').toUpperCase()===mm).length;
    const done=[...STUDENT_DATA.tarde,...STUDENT_DATA.aTiempo].filter(x=>String(x.momento||'').toUpperCase()===mm).length;
    return {title:`${MOM_MAP2[mm]} (${mm})`, pct:fmtPct(done,tot), frac:`${done}/${tot}`}; };
  const cards=[make('ALL'),make('M1'),make('M2'),make('M3')];
  $('resume-pcts').innerHTML=cards.map(c=>`<div class="card-mini"><div class="t">${c.title}</div><div class="v">${c.pct}</div><div class="t">${c.frac}</div></div>`).join('');
}
function renderTrabajoItem(t){ const fecha=normDate(t.fechaObjetivo)||t.fechaObjetivo||''; const mom=t.momento?` ¬∑ ${MOM_MAP2[t.momento]||t.momento}`:''; const nom=t.nombreTrabajo?` ¬∑ <i>${t.nombreTrabajo}</i>`:'';
  return `<details><summary><b>${t.materia||'‚Äì'}</b> ‚Äî ${t.numero||'‚Äì'} (${t.origen||'‚Äì'}${t.pagina?' ¬∑ p.'+t.pagina:''})${nom}${fecha?' ¬∑ '+fecha:''}${mom}</summary>
  <div class="hint">UID: <span class="mono">${t.uid||'(s/uid)'}</span></div></details>`; }
function renderStudentSections(){
  const falt=applyMomentFilter(STUDENT_DATA.faltantes), tar=applyMomentFilter(STUDENT_DATA.tarde), ati=applyMomentFilter(STUDENT_DATA.aTiempo);
  const total=falt.length+tar.length+ati.length, done=tar.length+ati.length;
  $('resume-pills').innerHTML=`<span class="pill bad">Faltantes: ${falt.length}</span>
    <span class="pill warn">Tarde: ${tar.length}</span><span class="pill ok">A tiempo: ${ati.length}</span>
    <span class="pill">Cumplimiento (filtro): ${done}/${total} ¬∑ ${fmtPct(done,total)}</span>`;
  buildPctCards();
  setHTML('faltantes', falt.length? falt.map(renderTrabajoItem).join('') : '<div class="empty">Sin faltantes.</div>');
  setHTML('tarde', tar.length? tar.map(renderTrabajoItem).join('') : '<div class="empty">Sin entregas tarde.</div>');
  setHTML('atiempo', ati.length? ati.map(renderTrabajoItem).join('') : '<div class="empty">Sin entregas a tiempo.</div>');
  // Urgentes (orden por fecha objetivo y atraso)
  const urg=[...STUDENT_DATA.faltantes].map(p=>({p, d: (new Date()-new Date(normDate(p.fechaObjetivo)||p.fechaObjetivo||new Date()))/86400000 }))
    .sort((a,b)=> (normDate(a.p.fechaObjetivo)||'') .localeCompare(normDate(b.p.fechaObjetivo)||'') || b.d-a.d).map(x=>x.p).slice(0,6);
  setHTML('faltantes-urg', urg.length? urg.map(renderTrabajoItem).join('') : '<div class="empty">Sin faltantes urgentes.</div>');
}

/* ===== OPEN STUDENT ===== */
async function openStudent(sheetId,cfg,alumno){
  $('student-title').textContent=`${alumno.nombre} ‚Äî ${alumno.id||''}`;
  $('student-meta').textContent='Cargando‚Ä¶'; setHTML('resume-pills',''); setHTML('faltantes',''); setHTML('tarde',''); setHTML('atiempo',''); setHTML('resume-pcts','');
  $('back-to-group').onclick=e=>{e.preventDefault();show('view-group');}; show('view-student'); MOM_FILTER='ALL'; setMomentChips();

  try{
    // Registro completo (para comparativas de grupo)
    let reg={cols:[],rows:[]}; try{reg=await loadSheetBlock(sheetId,'registro',cfg);}catch(e){}
    const entregasAll=parseRegistro(reg.cols,reg.rows);
    let entregasAlumno=entregasAll.filter(t=>normText(t.id)===normText(alumno.id));
    if(!entregasAlumno.length && alumno.nombre){entregasAlumno=entregasAll.filter(t=>normText(t.nombre)===normText(alumno.nombre));}

    // Presets
    let pres={cols:[],rows:[]}; try{pres=await loadSheetBlock(sheetId,'presets',cfg);}catch(e){}
    const presets=parsePresets(pres.cols,pres.rows);

    // Cruzar entregas ‚Üî presets
    const setUids=new Set(presets.map(p=>p.uid));
    const entregasPorUID=new Map(); const clavesEntregas=new Map();
    for(const t of entregasAlumno){ if(t.uidPreset) entregasPorUID.set(t.uidPreset,t); else clavesEntregas.set([normText(t.materia||''),normTrabajo(t.numero||''),normText(t.origen||''),normPagina(t.pagina||''),normDate(t.fechaObjetivo||'')].join('|'),t); }
    const faltantes=[], aTiempo=[], tarde=[];
    for(const p of presets){
      let ent=entregasPorUID.get(p.uid);
      if(!ent){ const k=[normText(p.materia||''),normTrabajo(p.numero||''),normText(p.origen||''),normPagina(p.pagina||''),normDate(p.fechaObjetivo||'')].join('|'); ent=clavesEntregas.get(k); }
      if(ent){(ent.atrasoDias>0?tarde:aTiempo).push({...p});} else {faltantes.push({...p});}
    }
    STUDENT_DATA={faltantes,tarde,aTiempo,alumno}; renderStudentSections();

    // ===== Asistencia y comparativas =====
    const asis=await loadSheetBlock(sheetId,'asistencia',cfg);
    const today=new Date();

    // Semana actual con fallback (como el KPI del home)
    const weekSet1=getWeekSet(today,false);
    const weekSet2=getWeekSet(today,true);
    function asistenciaBySetForStudent(set){
      const arr=Array.from(set);
      const a=asistenciaRangeForStudent(asis.cols,asis.rows,alumno,arr[0],arr[arr.length-1]);
      return a;
    }
    let wkA=asistenciaBySetForStudent(weekSet1);
    if(wkA.total===0) wkA=asistenciaBySetForStudent(weekSet2);
    if(wkA.total===0){
      const end=ymd(today); const start=ymd(new Date(today.getFullYear(),today.getMonth(),today.getDate()-6));
      wkA=asistenciaRangeForStudent(asis.cols,asis.rows,alumno,start,end);
    }

    const d30=ymd(new Date(today.getFullYear(),today.getMonth(),today.getDate()-30));
    // Alumno 30 d√≠as
    const d30A=asistenciaRangeForStudent(asis.cols,asis.rows,alumno,d30,ymd(today));
    // Grupo 30 d√≠as
    const d30G=asistenciaRangeForGroup(asis.cols,asis.rows,d30,ymd(today));

    const pctWk=wkA.total?Math.round((wkA.present/wkA.total)*100):0;
    const pct30=d30A.total?Math.round((d30A.present/d30A.total)*100):0;
    const pct30G=d30G.total?Math.round((d30G.present/d30G.total)*100):0;

    // Cumplimientos
    const deliveredAlumno=aTiempo.length+tarde.length; const totalPresets=presets.length;
    const cumpAlumno=totalPresets?Math.round((deliveredAlumno/totalPresets)*100):0;
    const alumnosCount=ALUMNOS?.length||0;
    const deliveredGrupo=entregasAll.filter(t=>setUids.has(t.uidPreset)).length;
    const expectedGrupo=alumnosCount*totalPresets;
    const cumpGrupo=expectedGrupo?Math.round((deliveredGrupo/expectedGrupo)*100):0;

    // Tarjeta resumen + riesgo
    const risk = (()=>{
      const faltRatio = totalPresets? faltantes.length/totalPresets : 0;
      if (faltantes.length>10 || faltRatio>0.2 || pct30<75) return 'high';
      if (faltantes.length>=5 || pct30<85) return 'med';
      return 'low';
    })();
    const card=$('summary-card'); card.classList.remove('risk-low','risk-med','risk-high'); card.classList.add(risk==='high'?'risk-high':risk==='med'?'risk-med':'risk-low');
    $('sum-cump').textContent= totalPresets? `${cumpAlumno}% (${deliveredAlumno}/${totalPresets})` : '‚Äì';
    $('sum-asis30').textContent= d30A.total? `${pct30}% (${d30A.present}/${d30A.total})` : '‚Äì';
    $('sum-asiswk').textContent= wkA.total? `${pctWk}% (${wkA.present}/${wkA.total})` : '‚Äì';
    $('sum-vsgrp').textContent= `${cumpAlumno}% / ${pct30}%  vs  ${cumpGrupo}% / ${pct30G}%`;
    $('sum-risk').textContent= risk==='high'?'ALTO':(risk==='med'?'MEDIO':'BAJO');

    // Sparkline + racha
    const serie=last4WeeksSeries(asis.cols,asis.rows,alumno); drawSpark('spark',serie);
    const racha=rachaInasistencias(asis.cols,asis.rows,alumno); $('streak').textContent=`Racha de inasistencias: ${racha} d√≠a(s)`;

    // Meta superior
    $('student-meta').textContent=`Hoja: ${sheetId} ¬∑ Presets: ${totalPresets} ¬∑ Entregas: ${deliveredAlumno} (tarde ${tarde.length}) ¬∑ Faltantes: ${faltantes.length}`;

    // Comparativa con grupo
    $('cmp-grupo').innerHTML=[
      {t:'Cumplimiento', v:`${cumpAlumno}%`, s:`Alumno: ${deliveredAlumno}/${totalPresets} ¬∑ Grupo: ${cumpGrupo}%`},
      {t:'Asistencia 30 d√≠as', v:`${pct30}%`, s:`Alumno: ${d30A.present}/${d30A.total} ¬∑ Grupo: ${pct30G}%`}
    ].map(x=>`<div class="card-mini"><div class="t">${x.t}</div><div class="v">${x.v}</div><div class="t">${x.s}</div></div>`).join('');

    // Contacto (Directorio)
    let contactoHTML='<div class="empty">Sin datos de contacto.</div>';
    try{
      const dir=await loadSheetBlock(sheetId,'directorio',cfg);
      const map=parseDirectorio(dir.cols,dir.rows);
      const keyId=normText(alumno.id), keyNom=normText(alumno.nombre);
      const c= map.get(keyId) || map.get(keyNom);
      if(c){ contactoHTML=`<div> Tutor: <b>${c.tutor||'‚Äì'}</b><br>Tel: ${c.tel?`<a href="tel:${c.tel}">${c.tel}</a>`:'‚Äì'} ¬∑ Email: ${c.mail?`<a href="mailto:${c.mail}">${c.mail}</a>`:'‚Äì'}</div>`; }
    }catch{}
    $('contacto').innerHTML=contactoHTML;

    // Notas (localStorage)
    const NOTES_KEY=`audqr_notes_${sheetId}_${normText(alumno.id||alumno.nombre)}`;
    const notas=JSON.parse(localStorage.getItem(NOTES_KEY)||'{}');
    $('nota-resumen').value=notas.resumen||''; $('nota-comp').value=notas.comp||''; $('nota-fecha').value=notas.fecha||'';
    $('btn-nota-save').onclick=()=>{ const v={resumen:$('nota-resumen').value, comp:$('nota-comp').value, fecha:$('nota-fecha').value, ts:new Date().toISOString()};
      localStorage.setItem(NOTES_KEY,JSON.stringify(v)); alert('Acuerdos guardados en este navegador.'); };
    $('btn-nota-print').onclick=()=>{ window.print(); };

  }catch(e){
    $('student-meta').textContent='Error al cargar datos.'; setHTML('faltantes',`<div class="empty">No se pudo leer.<br><span class="hint">${e.message}</span></div>`);
  }
}

/* ===== KPI controls ===== */
document.getElementById('kpi-this').onclick=()=>{KPI_PREF.mode='this'; saveKpiPref(); renderHome();};
document.getElementById('kpi-last').onclick=()=>{KPI_PREF.mode='last'; saveKpiPref(); renderHome();};
document.getElementById('kpi-go').onclick=()=>{KPI_PREF.mode='date'; KPI_PREF.date=$('kpi-date').value; saveKpiPref(); renderHome();};
document.getElementById('kpi-days').onchange=e=>{KPI_PREF.exp=e.target.value; saveKpiPref(); refreshAllKPIs();};

/* ===== Diagn√≥stico ===== */
async function diagnoseSheet(sheetId,cfg){
  const tests=[{name:'Asistencia',fn:()=>loadSheetBlock(sheetId,'asistencia',cfg)},
    {name:'Registro',fn:()=>loadSheetBlock(sheetId,'registro',cfg)},
    {name:'Presets',fn:()=>loadSheetBlock(sheetId,'presets',cfg)},
    {name:'Puntos',fn:()=>loadSheetBlock(sheetId,'puntos',cfg)}];
  let msg=`Diagn√≥stico ${sheetId}\n\n`;
  for(const t of tests){ try{const {cols,rows}=await t.fn(); msg+=`‚úî ${t.name}: ${cols.length} cols, ${rows.length} filas\n`; }
    catch(e){ msg+=`‚úñ ${t.name}: ${e.message}\n`; } }
  alert(msg);
}

/* ===== INIT ===== */
loadCfg(); loadKpiPref(); buildCfgTable(); renderHome();
$('back-to-home').onclick=e=>{e.preventDefault(); show('view-home');};
</script>
</body>
</html>
