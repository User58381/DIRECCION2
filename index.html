<!doctype html>
<html lang="es" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Aula Digital QR ‚Äî Faltantes y Asistencias (Directivo)</title>
<style>
  :root{
    /* DARK */
    --bg1:#0b1020; --bg2:#0a0d18;
    --header-bg:#0b1020cc;
    --border:#1a2540;
    --card:#121a30;
    --text:#eaf3ff;
    --muted:#90a4b4;
    --accent:#6aa9ff;
    --ghost-bg:#18243d;
    --input-bg:#0b1326;
    --input-bd:#24345c;
  }
  [data-theme="light"]{
    /* LIGHT */
    --bg1:#f6f8ff; --bg2:#eef2ff;
    --header-bg:#ffffffcc;
    --border:#dbe4ff;
    --card:#ffffff;
    --text:#0b1020;
    --muted:#5b6b7a;
    --accent:#2b6bff;
    --ghost-bg:#eef2ff;
    --input-bg:#ffffff;
    --input-bd:#c7d2fe;
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2))}
  header{position:sticky;top:0;z-index:10;background:var(--header-bg);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  header .wrap{max-width:1100px;margin:auto;padding:14px 16px;display:flex;gap:12px;align-items:center;color:var(--text)}
  header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
  header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  button,.chip{border:0;background:var(--accent);color:#07101f;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  button.ghost{background:var(--ghost-bg);color:var(--text)}
  button.small{padding:6px 10px;border-radius:8px;font-size:13px}
  main{max-width:1100px;margin:auto;padding:16px}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:14px}
  @media (min-width:860px){.grid{grid-template-columns:repeat(3,minmax(280px,1fr))}}
  .tile{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;display:flex;gap:12px;cursor:pointer;transition:.2s transform,.2s border-color}
  .tile:hover{transform:translateY(-1px);border-color:#2a3b66}
  .tile .ico{min-width:52px;height:52px;border-radius:14px;background:var(--ghost-bg);display:grid;place-items:center;font-weight:800;color:var(--accent)}
  .tile .name{color:var(--text);font-size:18px;font-weight:800}
  .tile .sub{color:var(--muted);font-size:12px;line-height:1.3}
  .tile .state{margin-left:auto;font-size:12px;color:var(--muted)}
  .panel{margin-top:18px;background:color-mix(in oklab, var(--card) 90%, transparent);border:1px dashed #2a3b66;border-radius:18px;padding:16px}
  .panel h3{margin:0 0 10px 0;color:var(--text);font-size:16px}
  table.cfg{width:100%;border-collapse:separate;border-spacing:0 8px}
  table.cfg th, table.cfg td{font-size:14px;color:var(--text)}
  table.cfg input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--input-bd);background:var(--input-bg);color:var(--text)}
  .view{display:none}
  .show{display:block}
  .list{margin-top:12px;background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden}
  .row{display:flex;gap:12px;align-items:center;padding:12px 14px;border-bottom:1px solid #19223f;color:var(--text);cursor:pointer}
  .row:last-child{border-bottom:0}
  .row .id{margin-left:auto;color:#9bb0c5;font-size:12px}
  .search{display:flex;gap:8px;margin:12px 0}
  .search input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--input-bd);background:var(--input-bg);color:var(--text)}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px}
  .pill.ok{background:#0f4636;color:#b6ffe1}
  .pill.warn{background:#4a3f16;color:#ffeaa7}
  .pill.bad{background:#4a1c1c;color:#ffd3d3}
  .section{margin-top:14px;background:var(--card);border:1px solid var(--border);border-radius:18px;padding:12px}
  .section h4{margin:0 0 8px 0}
  details{background:color-mix(in oklab, var(--ghost-bg) 80%, transparent);border:1px solid #203056;border-radius:12px;padding:8px 10px;margin:8px 0;color:var(--text)}
  summary{cursor:pointer;font-weight:700}
  .hint{color:var(--muted);font-size:12px}
  .empty{padding:12px;color:#9bb0c5}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#16213d;border:1px solid #263b6b;border-radius:6px;padding:0 6px}
  .back{display:inline-flex;gap:8px;align-items:center;color:var(--text);text-decoration:none}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .badge{background:color-mix(in oklab, var(--ghost-bg) 90%, transparent);border:1px solid #2a3b66;border-radius:999px;padding:6px 10px;color:#a7bed7;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üìò Aula Digital QR ‚Äî Faltantes por alumno</h1>
    <div class="right">
      <span class="badge">Modo director ¬∑ GViz JSONP (solo lectura)</span>
      <button id="btn-theme" class="ghost small" title="Cambiar tema">üåô Oscuro</button>
    </div>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="view-home" class="view show">
    <div class="grid" id="grupo-grid"></div>
    <div class="panel">
      <h3>‚öôÔ∏è Configurar hojas (URL/ID) y docente por grupo</h3>
      <table class="cfg" id="cfg-table"></table>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btn-save">Guardar</button>
        <button class="ghost" id="btn-clear">Borrar configuraci√≥n</button>
      </div>
      <p class="hint" style="margin-top:8px">
        Requiere <b>‚ÄúCualquiera con el enlace ‚Üí Lector‚Äù</b>.
        Se leen: <span class="mono">Asistencia</span>, <span class="mono">Registro de trabajos</span>, <span class="mono">Presets</span>.
      </p>
    </div>
  </section>

  <!-- GRUPO -->
  <section id="view-group" class="view">
    <a class="back" href="#" id="back-to-home">‚Üê Volver</a>
    <h2 id="group-title" style="color:var(--text);margin:8px 0 2px 0"></h2>
    <div id="group-teacher" class="hint" style="margin-bottom:10px"></div>
    <div class="search">
      <input id="q-alumno" placeholder="Buscar alumno por nombre o ID‚Ä¶"/>
      <div style="display:flex;gap:8px">
        <button id="btn-reload" class="ghost small">Recargar</button>
        <button id="btn-diagnose" class="ghost small">Diagn√≥stico</button>
      </div>
    </div>
    <div id="alumno-list" class="list"></div>
    <p class="hint">Fuente: Asistencia!A:B (con fallback a Puntos!A:B)</p>
  </section>

  <!-- ALUMNO -->
  <section id="view-student" class="view">
    <a class="back" href="#" id="back-to-group">‚Üê Volver al grupo</a>
    <h2 id="student-title" style="color:var(--text);margin:8px 0 2px 0"></h2>
    <div id="student-meta" class="hint"></div>

    <div class="section" id="resume">
      <h4>Resumen</h4>
      <div id="resume-pills"></div>
    </div>

    <div class="section">
      <h4>Faltantes</h4>
      <div id="faltantes"></div>
    </div>

    <div class="section">
      <h4>Entregados tarde</h4>
      <div id="tarde"></div>
    </div>

    <div class="section">
      <h4>Entregados (a tiempo)</h4>
      <div id="atiempo"></div>
    </div>

    <p class="hint">Cruce por UID_PRESET (como Boleta). Si falta UID, se intenta ‚Äúclave‚Äù (materia+n¬∫+origen+pag[+fecha]).</p>
  </section>
</main>

<script>
/* ====================== TEMA ====================== */
const THEME_KEY = 'audqr_theme';
const btnTheme = document.getElementById('btn-theme');
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem(THEME_KEY, t);
  btnTheme.textContent = t==='light' ? '‚òÄÔ∏è Claro' : 'üåô Oscuro';
}
(function initTheme(){
  const saved = localStorage.getItem(THEME_KEY) || 'dark';
  applyTheme(saved);
})();
btnTheme.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  applyTheme(cur==='dark' ? 'light' : 'dark');
});

/* ====================== UTILIDADES ====================== */
const GROUPS = [
  {code:'1A', label:'1ero A'}, {code:'1B', label:'1ero B'},
  {code:'2A', label:'2do A'},  {code:'2B', label:'2do B'},
  {code:'3A', label:'3ro A'},  {code:'3B', label:'3ro B'},
  {code:'4A', label:'4to A'},  {code:'4B', label:'4to B'},
  {code:'5A', label:'5to A'},  {code:'5B', label:'5to B'},
  {code:'6A', label:'6to A'},  {code:'6B', label:'6to B'},
];
const LS_KEY = 'audqr_sheets_v2';

const stripDiacritics = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
const normText = s => stripDiacritics(String(s||'').toLowerCase()).replace(/\s+/g,' ').trim();
const normTrabajo = s => normText(s).replace(/^trabajo\s*/,'');
const normPagina  = s => normText(s).replace(/^p\.?\s*/,'');
function normDate(s){
  const t = String(s||'').trim();
  if(!t) return '';
  const mIso = /^(\d{4}-\d{2}-\d{2})/.exec(t); if(mIso) return mIso[1];
  const mDMY = /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/.exec(t);
  if(mDMY){ const d=new Date(+mDMY[3], mDMY[2]-1, +mDMY[1]); return d.toISOString().slice(0,10); }
  const n = Number(t.replace(',','.')); if(!Number.isNaN(n)){ const base=new Date(1899,11,30); const d=new Date(base.getTime()+n*86400000); return d.toISOString().slice(0,10); }
  const d = new Date(t); if(!isNaN(+d)) return d.toISOString().slice(0,10);
  return '';
}
function extractSheetId(s){
  if(!s) return '';
  const m = String(s).match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if(m) return m[1];
  return s.trim(); // aceptar ID directo
}
function $(id){ return document.getElementById(id); }
function show(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('show');
  $(id).classList.add('show');
}
function setHTML(id, html){ $(id).innerHTML = html; }

/* Column matching tolerante */
function idxOfAnyLoose(cols, names){
  const norm = s => String(s||'').toLowerCase().replace(/[\s_]+/g,'').trim();
  const lc = cols.map(c=>norm(c));
  for(const k of names){ const i = lc.indexOf(norm(k)); if(i>=0) return i; }
  return -1;
}

/* ====================== GViz JSONP (sin CORS) ====================== */
let __jsonpSeq = 0;
function fetchGViz(sheetId, sheetName){
  return new Promise((resolve,reject)=>{
    const cb = `__gviz_cb_${Date.now()}_${++__jsonpSeq}`;
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json;responseHandler:${cb}&sheet=${encodeURIComponent(sheetName)}&ts=${Date.now()}`;
    const script = document.createElement('script');
    let timeout = setTimeout(()=>{ cleanup(); reject(new Error(`Timeout GViz ${sheetName}`)); }, 15000);
    function cleanup(){ clearTimeout(timeout); delete window[cb]; if(script.parentNode) script.parentNode.removeChild(script); }
    window[cb] = (json)=>{
      cleanup();
      try{
        const cols = (json.table?.cols||[]).map(c => (c.label||'').toString().trim());
        const rows = (json.table?.rows||[]).map(r => (r.c||[]).map(c => c?.v ?? ''));
        resolve({cols, rows});
      }catch(e){ reject(e); }
    };
    script.onerror = ()=>{ cleanup(); reject(new Error(`Error de red GViz ${sheetName}`)); };
    script.src = url; document.head.appendChild(script);
  });
}

/* ====================== HOME (config) ====================== */
let CFG = {};
function loadCfg(){
  try{ CFG = JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch{ CFG = {}; }
  for(const g of GROUPS){ if(!CFG[g.code]) CFG[g.code] = {sheetId:'', teacher:''}; else { CFG[g.code].teacher ||= ''; } }
}
function saveCfg(){ localStorage.setItem(LS_KEY, JSON.stringify(CFG)); }
function renderHome(){
  // Tiles
  const grid = GROUPS.map(g=>{
    const ok = !!CFG[g.code].sheetId;
    const teacher = CFG[g.code].teacher || '(sin asignar)';
    return `
      <div class="tile" data-code="${g.code}">
        <div class="ico">${g.code}</div>
        <div>
          <div class="name">${g.label}</div>
          <div class="sub">Docente: <b>${teacher}</b><br>${ok? 'Hoja configurada' : 'Sin hoja configurada'}</div>
        </div>
        <div class="state">${ok? '‚úÖ' : '‚ö†Ô∏è'}</div>
      </div>`;
  }).join('');
  setHTML('grupo-grid', grid);
  for(const el of document.querySelectorAll('.tile')){
    el.addEventListener('click', ()=>{
      const code = el.getAttribute('data-code');
      if(!CFG[code].sheetId){ alert('Configura primero la URL/ID de este grupo m√°s abajo y guarda.'); return; }
      openGroup(code);
    });
  }

  // Config table: Grupo | URL/ID | Docente
  const header = `
    <thead>
      <tr>
        <th style="text-align:left;width:110px">Grupo</th>
        <th style="text-align:left">URL o ID de la hoja</th>
        <th style="text-align:left;width:220px">Docente</th>
      </tr>
    </thead>`;
  const rows = GROUPS.map(g=>`
    <tr>
      <td><b>${g.label}</b></td>
      <td><input id="in-${g.code}-sheet" placeholder="URL o ID de la hoja" value="${CFG[g.code].sheetId ? 'https://docs.google.com/spreadsheets/d/'+CFG[g.code].sheetId+'/edit' : ''}"/></td>
      <td><input id="in-${g.code}-teacher" placeholder="Nombre del docente" value="${CFG[g.code].teacher||''}"/></td>
    </tr>`).join('');
  setHTML('cfg-table', `${header}<tbody>${rows}</tbody>`);
}
$('btn-save').addEventListener('click', ()=>{
  for(const g of GROUPS){
    const vs = $('in-'+g.code+'-sheet').value.trim();
    const vt = $('in-'+g.code+'-teacher').value.trim();
    CFG[g.code].sheetId = extractSheetId(vs);
    CFG[g.code].teacher = vt;
  }
  saveCfg(); renderHome();
  alert('Configuraci√≥n guardada.');
});
$('btn-clear').addEventListener('click', ()=>{
  if(confirm('¬øBorrar toda la configuraci√≥n guardada?')){
    localStorage.removeItem(LS_KEY);
    loadCfg(); renderHome();
  }
});

/* ====================== GRUPO ====================== */
let CURRENT_GROUP = null, CURRENT_SHEET = null;
let ALUMNOS = []; // {nombre, id}

async function loadAlumnos(sheetId){
  try{
    const {cols, rows} = await fetchGViz(sheetId, 'Asistencia');
    const iNombre = idxOfAnyLoose(cols, ['Nombre','Nombre del alumno']),
          iId     = idxOfAnyLoose(cols, ['ID','Id','id']);
    let list = rows.map(r=>({ nombre:String(r[iNombre]||'').trim(), id:String(r[iId]||'').trim() }))
                   .filter(x=>x.nombre || x.id);
    if(list.length===0) throw new Error('Asistencia vac√≠a');
    return list;
  }catch(e){
    const {cols, rows} = await fetchGViz(sheetId, 'Puntos');
    const iNombre = idxOfAnyLoose(cols, ['Nombre','Nombre del alumno']),
          iId     = idxOfAnyLoose(cols, ['ID','Id','id']);
    let list = rows.map(r=>({ nombre:String(r[iNombre]||'').trim(), id:String(r[iId]||'').trim() }))
                   .filter(x=>x.nombre || x.id);
    return list;
  }
}
function renderAlumnos(){
  const q = normText($('q-alumno').value);
  const items = ALUMNOS
    .filter(a=>!q || normText(a.nombre).includes(q) || normText(a.id).includes(q))
    .sort((a,b)=>a.nombre.localeCompare(b.nombre,'es'));
  if(items.length===0){ setHTML('alumno-list','<div class="empty">Sin resultados.</div>'); return; }
  setHTML('alumno-list', items.map(a=>`
    <div class="row" data-id="${a.id}" data-n="${encodeURIComponent(a.nombre)}">
      <div>${a.nombre||'(sin nombre)'}</div>
      <div class="id">${a.id||''}</div>
    </div>
  `).join(''));
  for(const el of document.querySelectorAll('#alumno-list .row')){
    el.addEventListener('click', ()=>{
      const id = el.getAttribute('data-id');
      const nombre = decodeURIComponent(el.getAttribute('data-n'));
      openStudent(CURRENT_SHEET, {id, nombre});
    });
  }
}
function openGroup(code){
  CURRENT_GROUP = code;
  CURRENT_SHEET = CFG[code].sheetId;
  const label = GROUPS.find(g=>g.code===code).label;
  $('group-title').textContent = `Grupo: ${label}`;
  $('group-teacher').textContent = `Docente: ${CFG[code].teacher || '(sin asignar)'}`;
  $('q-alumno').value = '';
  show('view-group');
  $('back-to-home').onclick = (e)=>{e.preventDefault(); show('view-home');};
  $('btn-reload').onclick = async ()=>{ ALUMNOS = await loadAlumnos(CURRENT_SHEET); renderAlumnos(); };
  $('q-alumno').oninput = renderAlumnos;
  $('btn-diagnose').onclick = ()=> diagnoseSheet(CURRENT_SHEET);
  (async ()=>{
    setHTML('alumno-list','<div class="empty">Cargando alumnos‚Ä¶</div>');
    try{ ALUMNOS = await loadAlumnos(CURRENT_SHEET); renderAlumnos(); }
    catch(e){ setHTML('alumno-list','<div class="empty">No se pudo cargar la lista de alumnos.</div>'); }
  })();
}

/* ====================== ALUMNO (faltantes/entregas/asistencia) ====================== */
function claveNoUID(t){
  return [
    normText(t.materia||''),
    normTrabajo(t.numero||''),
    normText(t.origen||''),
    normPagina(t.pagina||''),
    normDate(t.fechaObjetivo||''),
  ].join('|');
}
function parseRegistro(cols, rows){
  const idx = (names)=>idxOfAnyLoose(cols, names);
  const iUIDE = idx(['UID_ENTREGA','UID ENTREGA','UID Entrega','uid_entrega','uidentrega']);
  const iUIDP = idx(['UID_PRESET','UID PRESET','UID Preset','uid_preset','uidpreset']);
  const iF    = idx(['Fecha']);
  const iFO   = idx(['Fecha objetivo','Fecha Objetivo','Fecha_objetivo']);
  const iH    = idx(['Hora']);
  const iID   = idx(['ID','Id','id']);
  const iN    = idx(['Nombre','Nombre del alumno']);
  const iM    = idx(['Materia']);
  const iNum  = idx(['N¬∫ Trabajo','No. Trabajo','N¬∫','No','Numero','N√∫mero','NumTrabajo']);
  const iOri  = idx(['Origen']);
  const iPag  = idx(['P√°gina','Pagina']);
  const iPts  = idx(['Puntos']);
  const iAtr  = idx(['Atraso (d√≠as)','Atraso','Retraso','Atraso_dias']);
  const iMom  = idx(['Momento']);
  const iNomT = idx(['NombreTrabajo','Nombre Trabajo','Nombre_trabajo']);
  const iOrgS = idx(['OrigenScan','Origen Scan']);
  const iNot  = idx(['Notas']);

  return rows.map(r=>{
    const fecha = String(r[iF]??'').trim();
    const fo    = String((iFO>=0? r[iFO] : '')??'').trim() || fecha;
    const atraso = (()=> {
      if(iAtr>=0 && r[iAtr]!=='' && r[iAtr]!=null) return +r[iAtr]||0;
      const d = new Date(fecha), o = new Date(fo);
      if(isNaN(+d) || isNaN(+o)) return 0;
      return Math.max(0, Math.round((d - o)/86400000));
    })();
    return {
      uidEntrega:String((iUIDE>=0? r[iUIDE] : '')??'').trim(),
      uidPreset:String((iUIDP>=0? r[iUIDP] : '')??'').trim(),
      fecha, fechaObjetivo: fo, hora:String((iH>=0? r[iH] : '')??'').trim(),
      id:String((iID>=0? r[iID] : '')??'').trim(),
      nombre:String((iN>=0? r[iN] : '')??'').trim(),
      materia:String((iM>=0? r[iM] : '')??'').trim(),
      numero:String((iNum>=0? r[iNum] : '')??'').trim(),
      origen:String((iOri>=0? r[iOri] : '')??'').trim(),
      pagina:String((iPag>=0? r[iPag] : '')??'').trim(),
      puntos:+((iPts>=0? r[iPts] : 0)??0)||0,
      atrasoDias: atraso,
      momento:String((iMom>=0? r[iMom] : '')??'').trim(),
      nombreTrabajo:String((iNomT>=0? r[iNomT] : '')??'').trim(),
      origenScan:String((iOrgS>=0? r[iOrgS] : '')??'').trim(),
      notas:String((iNot>=0? r[iNot] : '')??'').trim(),
    }
  });
}
function parsePresets(cols, rows){
  const idx = (names)=>idxOfAnyLoose(cols, names);
  const iUID = idx(['UID_PRESET','UID PRESET','UID Preset','uid_preset','uidpreset']);
  const iFO  = idx(['Fecha objetivo','Fecha Objetivo','Fecha_objetivo']);
  const iMom = idx(['Momento']);
  const iMat = idx(['Materia']);
  const iNum = idx(['N¬∫ Trabajo','No. Trabajo','N¬∫','No','Numero','N√∫mero','NumTrabajo']);
  const iOri = idx(['Origen']);
  const iPag = idx(['P√°gina','Pagina']);
  const iNom = idx(['NombreTrabajo','Nombre Trabajo','Nombre_trabajo']);
  return rows.map(r=>({
    uid:String((iUID>=0? r[iUID] : '')??'').trim(),
    fechaObjetivo:String((iFO>=0? r[iFO] : '')??'').trim(),
    momento:String((iMom>=0? r[iMom] : '')??'').trim(),
    materia:String((iMat>=0? r[iMat] : '')??'').trim(),
    numero:String((iNum>=0? r[iNum] : '')??'').trim(),
    origen:String((iOri>=0? r[iOri] : '')??'').trim(),
    pagina:String((iPag>=0? r[iPag] : '')??'').trim(),
    nombreTrabajo:String((iNom>=0? r[iNom] : '')??'').trim(),
  })).filter(p=>p.uid);
}
async function loadAsistenciaResumen(sheetId, alumnoId){
  try{
    const {cols, rows} = await fetchGViz(sheetId,'Asistencia');
    const iId = idxOfAnyLoose(cols,['ID','Id','id']);
    if(iId<0) return {asistencias:0, faltas:0, total:0};
    const row = rows.find(r=> String(r[iId]??'').trim().toLowerCase() === String(alumnoId||'').trim().toLowerCase());
    if(!row) return {asistencias:0, faltas:0, total:0};
    const dateCols = cols.map((c,i)=>(/^\d{4}-\d{2}-\d{2}$/.test(String(c).trim())? i : -1)).filter(i=>i>=0);
    let presentes=0, total=0;
    for(const i of dateCols){
      const v = row[i];
      if(v!==null && v!=='' ) { total++; if(String(v).trim()==='1' || v===1 || v===1.0) presentes++; }
    }
    return {asistencias:presentes, faltas: Math.max(0,total-presentes), total};
  }catch{ return {asistencias:0,faltas:0,total:0}; }
}
function renderTrabajoItem(t){
  const fecha = normDate(t.fechaObjetivo)||t.fechaObjetivo||'';
  const nombreT = t.nombreTrabajo ? ` ¬∑ <i>${t.nombreTrabajo}</i>` : '';
  return `<details>
    <summary><b>${t.materia||'‚Äì'}</b> ‚Äî ${t.numero||'‚Äì'} (${t.origen||'‚Äì'}${t.pagina? ' ¬∑ p.'+t.pagina : ''})${nombreT}${fecha? ' ¬∑ '+fecha:''}</summary>
    <div class="hint">Momento: ${t.momento||'‚Äì'} ¬∑ UID: <span class="mono">${t.uid||'(s/uid)'}</span></div>
  </details>`;
}

async function openStudent(sheetId, alumno){
  $('student-title').textContent = `${alumno.nombre} ‚Äî ${alumno.id||''}`;
  $('student-meta').textContent = 'Cargando‚Ä¶';
  setHTML('resume-pills',''); setHTML('faltantes',''); setHTML('tarde',''); setHTML('atiempo','');
  $('back-to-group').onclick = (e)=>{e.preventDefault(); show('view-group');};
  show('view-student');

  try{
    let reg = [], presets = [];
    try{ const R = await fetchGViz(sheetId,'Registro de trabajos'); reg = parseRegistro(R.cols, R.rows); }catch(e){}
    try{ const P = await fetchGViz(sheetId,'Presets'); presets = parsePresets(P.cols, P.rows); }catch(e){}

    const entregasAlumno = reg.filter(t => String(t.id||'').trim().toLowerCase() === String(alumno.id||'').trim().toLowerCase());

    const entregasPorUID = new Map();
    const clavesEntregas = new Map();
    for(const t of entregasAlumno){
      if(t.uidPreset) entregasPorUID.set(t.uidPreset, t);
      else            clavesEntregas.set(claveNoUID(t), t);
    }

    const faltantes = [], aTiempo = [], tarde = [];
    if(presets.length){
      for(const p of presets){
        let ent = entregasPorUID.get(p.uid);
        if(!ent){
          const k = [normText(p.materia||''), normTrabajo(p.numero||''), normText(p.origen||''), normPagina(p.pagina||''), normDate(p.fechaObjetivo||'')].join('|');
          ent = clavesEntregas.get(k);
        }
        if(ent){ (ent.atrasoDias>0? tarde : aTiempo).push({...p}); }
        else   { faltantes.push({...p}); }
      }
    }

    const {asistencias, faltas, total} = await loadAsistenciaResumen(sheetId, alumno.id);

    setHTML('resume-pills', `
      <span class="pill bad">Faltantes: ${faltantes.length}</span>
      <span class="pill warn">Tarde: ${tarde.length}</span>
      <span class="pill ok">A tiempo: ${aTiempo.length}</span>
      <span class="pill">Asistencias: ${asistencias}/${total}</span>
    `);
    $('student-meta').textContent = `Hoja: ${sheetId}`;

    setHTML('faltantes', faltantes.length ? faltantes.map(renderTrabajoItem).join('') : '<div class="empty">Sin faltantes (seg√∫n Presets).</div>');
    setHTML('tarde',     tarde.length     ? tarde.map(renderTrabajoItem).join('')     : '<div class="empty">Sin entregas tarde.</div>');
    setHTML('atiempo',   aTiempo.length   ? aTiempo.map(renderTrabajoItem).join('')   : '<div class="empty">Sin entregas a tiempo.</div>');

  }catch(e){
    $('student-meta').textContent = 'Error al cargar datos.';
    setHTML('faltantes','<div class="empty">No se pudieron leer los datos.</div>');
    setHTML('tarde',''); setHTML('atiempo','');
  }
}

/* ====================== Diagn√≥stico ====================== */
async function diagnoseSheet(sheetId){
  const tests = [
    {name:'Puntos', fn:()=>fetchGViz(sheetId,'Puntos')},
    {name:'Asistencia', fn:()=>fetchGViz(sheetId,'Asistencia')},
    {name:'Registro de trabajos', fn:()=>fetchGViz(sheetId,'Registro de trabajos')},
    {name:'Presets', fn:()=>fetchGViz(sheetId,'Presets')},
  ];
  let msg = `Diagn√≥stico de hoja ${sheetId}\n`;
  for(const t of tests){
    try{ const {cols, rows} = await t.fn(); msg += `‚úî ${t.name}: ${cols.length} columnas, ${rows.length} filas\n`; }
    catch(e){ msg += `‚úñ ${t.name}: ${e.message}\n`; }
  }
  alert(msg);
}

/* ====================== INIT ====================== */
loadCfg();
renderHome();
$('back-to-home').onclick = (e)=>{e.preventDefault(); show('view-home');};
</script>
</body>
</html>
