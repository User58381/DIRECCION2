<!doctype html>
<html lang="es" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Aula Digital QR ‚Äî Faltantes y Asistencias (Directivo)</title>
<style>
  :root{
    --bg1:#0b1020; --bg2:#0a0d18; --header-bg:#0b1020cc; --border:#1a2540;
    --card:#121a30; --text:#eaf3ff; --muted:#90a4b4; --accent:#6aa9ff;
    --ghost-bg:#18243d; --input-bg:#0b1326; --input-bd:#24345c;
  }
  [data-theme="light"]{
    --bg1:#f6f8ff; --bg2:#eef2ff; --header-bg:#ffffffcc; --border:#dbe4ff;
    --card:#ffffff; --text:#0b1020; --muted:#5b6b7a; --accent:#2b6bff;
    --ghost-bg:#eef2ff; --input-bg:#ffffff; --input-bd:#c7d2fe;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2))}
  header{position:sticky;top:0;z-index:10;background:var(--header-bg);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  header .wrap{max-width:1100px;margin:auto;padding:14px 16px;display:flex;gap:12px;align-items:center;color:var(--text)}
  header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
  header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  button,.chip{border:0;background:var(--accent);color:#07101f;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  button.ghost{background:var(--ghost-bg);color:var(--text)}
  button.small{padding:6px 10px;border-radius:8px;font-size:13px}
  main{max-width:1100px;margin:auto;padding:16px}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:14px}
  @media (min-width:860px){.grid{grid-template-columns:repeat(3,minmax(280px,1fr))}}
  .tile{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;display:flex;gap:12px;cursor:pointer;transition:.2s transform,.2s border-color}
  .tile:hover{transform:translateY(-1px);border-color:#2a3b66}
  .tile .ico{min-width:52px;height:52px;border-radius:14px;background:var(--ghost-bg);display:grid;place-items:center;font-weight:800;color:var(--accent)}
  .tile .name{color:var(--text);font-size:18px;font-weight:800}
  .tile .sub{color:var(--muted);font-size:12px;line-height:1.3}
  .tile .state{margin-left:auto;font-size:12px;color:var(--muted)}
  .panel{margin-top:18px;background:color-mix(in oklab, var(--card) 90%, transparent);border:1px dashed #2a3b66;border-radius:18px;padding:16px}
  .panel h3{margin:0 0 10px 0;color:var(--text);font-size:16px}
  table.cfg{width:100%;border-collapse:separate;border-spacing:0 8px}
  table.cfg th, table.cfg td{font-size:14px;color:var(--text);vertical-align:top}
  table.cfg input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--input-bd);background:var(--input-bg);color:var(--text)}
  /* === Avanzado: GIDs === */
  .gid-box-title{margin-top:6px;margin-bottom:4px;font-weight:700;color:var(--text);font-size:13px}
  .cfg-small{display:grid;grid-template-columns:1fr;gap:12px;margin-top:8px}
  @media (min-width:860px){ .cfg-small{grid-template-columns:repeat(2,minmax(280px,1fr));} }
  .gid-group{display:flex;flex-direction:column;gap:6px}
  .gid-label{font-size:12px;color:var(--muted)}
  .gid-input{
    font-size:16px; padding:12px 14px; border-radius:12px; border:2px solid var(--input-bd);
    background:var(--input-bg); color:var(--text); font-family:ui-monospace,Consolas,monospace;
  }
  .view{display:none}
  .show{display:block}
  .list{margin-top:12px;background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden}
  .row{display:flex;gap:12px;align-items:center;padding:12px 14px;border-bottom:1px solid #19223f;color:var(--text);cursor:pointer}
  .row:last-child{border-bottom:0}
  .row .id{margin-left:auto;color:#9bb0c5;font-size:12px}
  .search{display:flex;gap:8px;margin:12px 0}
  .search input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--input-bd);background:var(--input-bg);color:var(--text)}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px}
  .pill.ok{background:#0f4636;color:#b6ffe1}
  .pill.warn{background:#4a3f16;color:#ffeaa7}
  .pill.bad{background:#4a1c1c;color:#ffd3d3}
  .section{margin-top:14px;background:var(--card);border:1px solid var(--border);border-radius:18px;padding:12px}
  .section h4{margin:0 0 8px 0}
  details{background:color-mix(in oklab, var(--ghost-bg) 80%, transparent);border:1px solid #203056;border-radius:12px;padding:8px 10px;margin:8px 0;color:var(--text)}
  summary{cursor:pointer;font-weight:700}
  .hint{color:var(--muted);font-size:12px}
  .empty{padding:12px;color:#9bb0c5}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#16213d;border:1px solid #263b6b;border-radius:6px;padding:0 6px}
  .back{display:inline-flex;gap:8px;align-items:center;color:var(--text);text-decoration:none}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .badge{background:color-mix(in oklab, var(--ghost-bg) 90%, transparent);border:1px solid #2a3b66;border-radius:999px;padding:6px 10px;color:#a7bed7;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üìò Aula Digital QR ‚Äî Faltantes por alumno</h1>
    <div class="right">
      <span class="badge">GViz + CSV (fallback por GID) ¬∑ s√≥lo lectura</span>
      <button id="btn-theme" class="ghost small" title="Cambiar tema">üåô Oscuro</button>
    </div>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="view-home" class="view show">
    <div class="grid" id="grupo-grid"></div>
    <div class="panel">
      <h3>‚öôÔ∏è Configurar hojas por grupo</h3>
      <table class="cfg" id="cfg-table"></table>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btn-save">Guardar</button>
        <button class="ghost" id="btn-clear">Borrar configuraci√≥n</button>
      </div>
      <p class="hint" style="margin-top:8px">
        üß© <b>Avanzado: GIDs</b> ‚Äî pega <b>s√≥lo el n√∫mero</b> que aparece en la URL tras <span class="mono">#gid=</span> estando en cada pesta√±a (Puntos, Asistencia, Registro de trabajos, Presets).
      </p>
    </div>
  </section>

  <!-- GRUPO -->
  <section id="view-group" class="view">
    <a class="back" href="#" id="back-to-home">‚Üê Volver</a>
    <h2 id="group-title" style="color:var(--text);margin:8px 0 2px 0"></h2>
    <div id="group-teacher" class="hint" style="margin-bottom:10px"></div>
    <div class="search">
      <input id="q-alumno" placeholder="Buscar alumno por nombre o ID‚Ä¶"/>
      <div style="display:flex;gap:8px">
        <button id="btn-reload" class="ghost small">Recargar</button>
        <button id="btn-diagnose" class="ghost small">Diagn√≥stico</button>
      </div>
    </div>
    <div id="alumno-list" class="list"></div>
    <p class="hint">Lee: <span class="mono">Asistencia</span> (o GID), <span class="mono">Registro de trabajos</span> (o GID), <span class="mono">Presets</span> (o GID). Fallback de alumnos por <span class="mono">Puntos</span> (o GID).</p>
  </section>

  <!-- ALUMNO -->
  <section id="view-student" class="view">
    <a class="back" href="#" id="back-to-group">‚Üê Volver al grupo</a>
    <h2 id="student-title" style="color:var(--text);margin:8px 0 2px 0"></h2>
    <div id="student-meta" class="hint"></div>

    <div class="section">
      <h4>Resumen</h4>
      <div id="resume-pills"></div>
    </div>

    <div class="section">
      <h4>Faltantes</h4>
      <div id="faltantes"></div>
    </div>

    <div class="section">
      <h4>Entregados tarde</h4>
      <div id="tarde"></div>
    </div>

    <div class="section">
      <h4>Entregados (a tiempo)</h4>
      <div id="atiempo"></div>
    </div>

    <p class="hint">Cruce por UID_PRESET. Si falta UID, intenta ‚Äúclave‚Äù (materia+n¬∫+origen+pag[+fecha]).</p>
  </section>
</main>

<script>
/* ===== TEMA ===== */
const THEME_KEY='audqr_theme';
const btnTheme=document.getElementById('btn-theme');
function applyTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem(THEME_KEY,t);btnTheme.textContent=t==='light'?'‚òÄÔ∏è Claro':'üåô Oscuro';}
(function(){applyTheme(localStorage.getItem(THEME_KEY)||'dark');})();
btnTheme.addEventListener('click',()=>{applyTheme((document.documentElement.getAttribute('data-theme')||'dark')==='dark'?'light':'dark');});

/* ===== UTIL ===== */
const GROUPS=[{code:'1A',label:'1ero A'},{code:'1B',label:'1ero B'},{code:'2A',label:'2do A'},{code:'2B',label:'2do B'},{code:'3A',label:'3ro A'},{code:'3B',label:'3ro B'},{code:'4A',label:'4to A'},{code:'4B',label:'4to B'},{code:'5A',label:'5to A'},{code:'5B',label:'5to B'},{code:'6A',label:'6to A'},{code:'6B',label:'6to B'}];
const LS_KEY='audqr_sheets_v6';
const stripDiacritics=s=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
const normText=s=>stripDiacritics(String(s||'').toLowerCase()).replace(/\s+/g,' ').trim();
const normTrabajo=s=>normText(s).replace(/^trabajo\s*/,'');
const normPagina=s=>normText(s).replace(/^p\.?\s*/,'');
function normDate(s){
  const t=String(s||'').trim(); if(!t) return '';
  const mIso=/^(\d{4}-\d{2}-\d{2})/.exec(t); if(mIso) return mIso[1];
  const mDMY=/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/.exec(t);
  if(mDMY){ const d=new Date(+mDMY[3],mDMY[2]-1,+mDMY[1]); return d.toISOString().slice(0,10); }
  const n=Number(t.replace(',','.')); if(!Number.isNaN(n)){ const base=new Date(1899,11,30); const d=new Date(base.getTime()+n*86400000); return d.toISOString().slice(0,10); }
  const d=new Date(t); if(!isNaN(+d)) return d.toISOString().slice(0,10);
  return '';
}
function extractSheetId(s){if(!s) return ''; const m=String(s).match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); return m?m[1]:s.trim();}
function $(id){return document.getElementById(id);}
function show(id){for(const el of document.querySelectorAll('.view')) el.classList.remove('show'); $(id).classList.add('show');}
function setHTML(id,html){$(id).innerHTML=html;}
function idxOfAnyLoose(cols,names){const norm=s=>String(s||'').toLowerCase().replace(/[\s_]+/g,'').trim(); const lc=cols.map(c=>norm(c)); for(const k of names){const i=lc.indexOf(norm(k)); if(i>=0) return i;} return -1;}

/* === Heur√≠sticas especiales para tu estructura === */
// Detecta la columna de ID aunque el encabezado no sea "ID" (busca valores tipo IDXXXXX)
function findIdColumn(cols, rows){
  let i = idxOfAnyLoose(cols, ['ID','Id','id','Matricula','Matr√≠cula','CURP','No Lista','N Lista','No_Lista','NUA','Numero lista','N¬∞ Lista','Lista']);
  if (i >= 0) return i;
  const maxRows = Math.min(rows.length, 30);
  const score = new Array(cols.length).fill(0);
  for (let r = 0; r < maxRows; r++){
    const row = rows[r] || [];
    for (let c = 0; c < cols.length; c++){
      const v = String(row[c] ?? '').trim();
      if (!v) continue;
      if (/^ID[A-Z0-9]{4,}$/i.test(v)) score[c] += 3;
      if (/^[A-Z0-9]{8,}$/.test(v))     score[c] += 1;
      if (v.length >= 8 && v.length <= 16) score[c] += 0.5;
    }
  }
  let best = -1, bestScore = 0;
  for (let c = 0; c < score.length; c++){ if (score[c] > bestScore){ bestScore = score[c]; best = c; } }
  return bestScore > 0 ? best : -1;
}
function getDateColumns(cols){ return cols.map((c,i)=> normDate(String(c).trim()) ? i : -1).filter(i=>i>=0); }
function isPresent(v){
  const s = normText(v); if(!s) return false;
  if (!Number.isNaN(+s)) return (+s)>0;
  const s2 = s.replace(/\s+/g,'');
  if (/^1\(100%?\)$/.test(s2)) return true;
  return ['x','‚úì','‚úî','p','presente','si','s√≠','s','ok','true','asistio','asisti√≥'].includes(s);
}

/* ===== LECTORES ===== */
let __jsonpSeq=0;
function fetchGViz(sheetId,sheetName){
  return new Promise((resolve,reject)=>{
    const cb=`__gviz_cb_${Date.now()}_${++__jsonpSeq}`;
    const url=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?headers=1&tqx=out:json;responseHandler:${cb}&sheet=${encodeURIComponent(sheetName)}&ts=${Date.now()}`;
    const script=document.createElement('script');
    let timeout=setTimeout(()=>{cleanup();reject(new Error(`Timeout GViz ${sheetName}`));},12000);
    function cleanup(){clearTimeout(timeout);delete window[cb];if(script.parentNode)script.parentNode.removeChild(script);}
    window[cb]=(json)=>{cleanup();try{
      let cols=(json.table?.cols||[]).map(c=>(c.label||'').toString().trim());
      let rows=(json.table?.rows||[]).map(r=>(r.c||[]).map(c=>c?.v ?? ''));
      const emptyOrGeneric=cols.filter(c=>!c || /^[A-Z]$/.test(c)).length;
      if(emptyOrGeneric>=Math.ceil(cols.length*0.5) && rows.length){const header=rows[0].map(v=>(v??'').toString().trim()); cols=header; rows=rows.slice(1);}
      resolve({cols,rows});
    }catch(e){reject(e);} };
    script.onerror=()=>{cleanup();reject(new Error(`Error de red GViz ${sheetName}`));};
    script.src=url;document.head.appendChild(script);
  });
}
async function fetchCSVByGid(sheetId,gid){
  const url=`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${encodeURIComponent(gid)}&ts=${Date.now()}`;
  const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error(`CSV ${gid} -> ${res.status}`);
  const text=await res.text(); const rows=parseCSV(text); const cols=(rows.shift()||[]).map(v=>(v??'').toString().trim()); return {cols,rows};
}
function parseCSV(text){
  const rows=[]; let row=[]; let cur=''; let inQ=false;
  for(let i=0;i<text.length;i++){const ch=text[i],nx=text[i+1];
    if(inQ){ if(ch==='"'&&nx==='"'){cur+='"';i++;} else if(ch==='"'){inQ=false;} else cur+=ch; }
    else { if(ch==='"'){inQ=true;} else if(ch===','){row.push(cur);cur='';}
      else if(ch==='\n'||ch==='\r'){ if(cur!==''||row.length){row.push(cur);rows.push(row);row=[];cur='';} }
      else cur+=ch; } }
  if(cur!==''||row.length){row.push(cur);rows.push(row);} return rows;
}
const NAME_CANDIDATES={
  asistencia:['Asistencia','asistencia','ASISTENCIA','Lista','Lista de asistencia','Lista de Asistencia'],
  registro:['Registro de trabajos','Registro','Trabajos','Historial','Registro trabajos','Registro_de_trabajos'],
  presets:['Presets','Cat√°logo','Catalogo','Tareas','Preset','Cat√°logo de trabajos'],
  puntos:['Puntos','puntos','PUNtos']
};
async function loadSheetBlock(sheetId,blockKey,cfg){
  const names=NAME_CANDIDATES[blockKey]||[];
  for(const n of names){try{return await fetchGViz(sheetId,n);}catch(e){}}
  const gid=(cfg.gids||{})[blockKey]||''; if(gid) return await fetchCSVByGid(sheetId,gid);
  throw new Error(`No se encontr√≥ la pesta√±a "${blockKey}" (probados: ${names.join(', ')}) y no hay GID configurado.`);
}

/* ===== HOME ===== */
let CFG={};
function loadCfg(){
  try{CFG=JSON.parse(localStorage.getItem(LS_KEY)||'{}');}catch{CFG={};}
  for(const g of GROUPS){
    if(!CFG[g.code]) CFG[g.code]={sheetId:'',teacher:'',gids:{puntos:'',asistencia:'',registro:'',presets:''}};
    CFG[g.code].gids ||= {puntos:'',asistencia:'',registro:'',presets:''};
    CFG[g.code].teacher ||= '';
  }
}
function saveCfg(){localStorage.setItem(LS_KEY, JSON.stringify(CFG));}

function renderHome(){
  const grid=GROUPS.map(g=>{
    const ok=!!CFG[g.code].sheetId; const teacher=CFG[g.code].teacher||'(sin asignar)';
    return `<div class="tile" data-code="${g.code}">
      <div class="ico">${g.code}</div>
      <div><div class="name">${g.label}</div>
      <div class="sub">Docente: <b>${teacher}</b><br>${ok?'Hoja configurada':'Sin hoja configurada'}</div></div>
      <div class="state">${ok?'‚úÖ':'‚ö†Ô∏è'}</div>
    </div>`;
  }).join('');
  setHTML('grupo-grid',grid);
  for(const el of document.querySelectorAll('.tile')){
    el.addEventListener('click',()=>{
      const code=el.getAttribute('data-code');
      if(!CFG[code].sheetId){alert('Configura primero la URL/ID de este grupo y guarda.');return;}
      openGroup(code);
    });
  }

  const header=`<thead><tr>
    <th style="text-align:left;width:110px">Grupo</th>
    <th style="text-align:left">URL o ID de la hoja</th>
    <th style="text-align:left;width:260px">Docente</th>
  </tr></thead>`;

  const rows=GROUPS.map(g=>{
    const cfg=CFG[g.code];
    return `<tr>
      <td>
        <b>${g.label}</b>
        <div class="gid-box-title">üß© Avanzado: GIDs por pesta√±a</div>
        <div class="cfg-small">
          <label class="gid-group">
            <span class="gid-label">1) <b>Puntos</b> ‚Äî pega el n√∫mero tras <span class="mono">#gid=‚Ä¶</span></span>
            <input id="gid-${g.code}-puntos" class="gid-input" placeholder="ej. 123456789" title="Pega solo el n√∫mero que ves al final de la URL (#gid=‚Ä¶)" value="${cfg.gids.puntos||''}">
          </label>
          <label class="gid-group">
            <span class="gid-label">2) <b>Asistencia</b> ‚Äî n√∫mero tras <span class="mono">#gid=‚Ä¶</span></span>
            <input id="gid-${g.code}-asistencia" class="gid-input" placeholder="ej. 987654321" title="Pega solo el n√∫mero que ves al final de la URL (#gid=‚Ä¶)" value="${cfg.gids.asistencia||''}">
          </label>
          <label class="gid-group">
            <span class="gid-label">3) <b>Registro de trabajos</b> ‚Äî n√∫mero tras <span class="mono">#gid=‚Ä¶</span></span>
            <input id="gid-${g.code}-registro" class="gid-input" placeholder="ej. 135791357" title="Pega solo el n√∫mero que ves al final de la URL (#gid=‚Ä¶)" value="${cfg.gids.registro||''}">
          </label>
          <label class="gid-group">
            <span class="gid-label">4) <b>Presets</b> ‚Äî n√∫mero tras <span class="mono">#gid=‚Ä¶</span></span>
            <input id="gid-${g.code}-presets" class="gid-input" placeholder="ej. 246802468" title="Pega solo el n√∫mero que ves al final de la URL (#gid=‚Ä¶)" value="${cfg.gids.presets||''}">
          </label>
        </div>
      </td>
      <td><input id="in-${g.code}-sheet" placeholder="URL o ID de la hoja (pega el enlace general)" value="${cfg.sheetId ? 'https://docs.google.com/spreadsheets/d/'+cfg.sheetId+'/edit' : ''}"/></td>
      <td><input id="in-${g.code}-teacher" placeholder="Nombre del docente" value="${cfg.teacher||''}"/></td>
    </tr>`;
  }).join('');

  setHTML('cfg-table',`${header}<tbody>${rows}</tbody>`);
}
$('btn-save').addEventListener('click',()=>{
  for(const g of GROUPS){
    const vs=$('in-'+g.code+'-sheet').value.trim();
    const vt=$('in-'+g.code+'-teacher').value.trim();
    CFG[g.code].sheetId=extractSheetId(vs);
    CFG[g.code].teacher=vt;
    CFG[g.code].gids={
      puntos:$('gid-'+g.code+'-puntos').value.trim(),
      asistencia:$('gid-'+g.code+'-asistencia').value.trim(),
      registro:$('gid-'+g.code+'-registro').value.trim(),
      presets:$('gid-'+g.code+'-presets').value.trim()
    };
  }
  saveCfg(); renderHome(); alert('Configuraci√≥n guardada.');
});
$('btn-clear').addEventListener('click',()=>{
  if(confirm('¬øBorrar toda la configuraci√≥n guardada?')){localStorage.removeItem(LS_KEY);loadCfg();renderHome();}
});

/* ===== GRUPO ===== */
let CURRENT_GROUP=null, CURRENT_SHEET=null, CURRENT_CFG=null; let ALUMNOS=[];
async function loadAlumnos(sheetId,cfg){
  try{
    const {cols,rows}=await loadSheetBlock(sheetId,'asistencia',cfg);
    const iNombre=idxOfAnyLoose(cols,['Nombre','Nombre del alumno','Alumno','Apellidos y Nombres','Nombre y Apellido']);
    const iId=findIdColumn(cols,rows);
    const list=rows.map(r=>({nombre:String(r[iNombre]||'').trim(), id:(iId>=0? String(r[iId]||'').trim() : '')})).filter(x=>x.nombre||x.id);
    if(list.length===0) throw new Error('Asistencia vac√≠a'); return list;
  }catch(e){
    const {cols,rows}=await loadSheetBlock(sheetId,'puntos',cfg);
    const iNombre=idxOfAnyLoose(cols,['Nombre','Nombre del alumno','Alumno','Apellidos y Nombres','Nombre y Apellido']);
    const iId=findIdColumn(cols,rows);
    return rows.map(r=>({nombre:String(r[iNombre]||'').trim(), id:(iId>=0? String(r[iId]||'').trim() : '')})).filter(x=>x.nombre||x.id);
  }
}
function renderAlumnos(){
  const q=normText($('q-alumno').value);
  const items=ALUMNOS.filter(a=>!q||normText(a.nombre).includes(q)||normText(a.id).includes(q)).sort((a,b)=>a.nombre.localeCompare(b.nombre,'es'));
  if(items.length===0){setHTML('alumno-list','<div class="empty">Sin resultados.</div>');return;}
  setHTML('alumno-list',items.map(a=>`<div class="row" data-id="${a.id}" data-n="${encodeURIComponent(a.nombre)}"><div>${a.nombre||'(sin nombre)'}</div><div class="id">${a.id||''}</div></div>`).join(''));
  for(const el of document.querySelectorAll('#alumno-list .row')){
    el.addEventListener('click',()=>{const id=el.getAttribute('data-id'); const nombre=decodeURIComponent(el.getAttribute('data-n')); openStudent(CURRENT_SHEET, CURRENT_CFG, {id,nombre});});
  }
}
function openGroup(code){
  CURRENT_GROUP=code; CURRENT_CFG=CFG[code]; CURRENT_SHEET=CURRENT_CFG.sheetId;
  const label=GROUPS.find(g=>g.code===code).label;
  $('group-title').textContent=`Grupo: ${label}`;
  $('group-teacher').textContent=`Docente: ${CURRENT_CFG.teacher||'(sin asignar)'}`;
  $('q-alumno').value='';
  show('view-group');
  $('back-to-home').onclick=e=>{e.preventDefault();show('view-home');};
  $('btn-reload').onclick=async()=>{ALUMNOS=await loadAlumnos(CURRENT_SHEET, CURRENT_CFG); renderAlumnos();};
  $('q-alumno').oninput=renderAlumnos;
  $('btn-diagnose').onclick=()=>diagnoseSheet(CURRENT_SHEET, CURRENT_CFG);
  (async()=>{
    setHTML('alumno-list','<div class="empty">Cargando alumnos‚Ä¶</div>');
    try{ALUMNOS=await loadAlumnos(CURRENT_SHEET, CURRENT_CFG); renderAlumnos();}
    catch(e){setHTML('alumno-list',`<div class="empty">No se pudo cargar la lista de alumnos.<br><span class="hint">${e.message}</span></div>`);}
  })();
}

/* ===== ALUMNO ===== */
function claveNoUID(t){return[normText(t.materia||''),normTrabajo(t.numero||''),normText(t.origen||''),normPagina(t.pagina||''),normDate(t.fechaObjetivo||'')].join('|');}
function parseRegistro(cols,rows){
  const idx=names=>idxOfAnyLoose(cols,names);
  const iUIDE=idx(['UID_ENTREGA','UID ENTREGA','UID Entrega','uid_entrega','uidentrega']);
  const iUIDP=idx(['UID_PRESET','UID PRESET','UID Preset','uid_preset','uidpreset']);
  const iF=idx(['Fecha']), iFO=idx(['Fecha objetivo','Fecha Objetivo','Fecha_objetivo']), iH=idx(['Hora']);
  const iID=idx(['ID','Id','id','Matricula','Matr√≠cula','CURP','No Lista','N Lista','No_Lista','NUA']); // m√°s sin√≥nimos
  const iN=idx(['Nombre','Nombre del alumno','Alumno','Apellidos y Nombres','Nombre y Apellido']);
  const iM=idx(['Materia']);
  const iNum=idx(['N¬∫ Trabajo','No. Trabajo','N¬∫','No','Numero','N√∫mero','NumTrabajo']);
  const iOri=idx(['Origen']), iPag=idx(['P√°gina','Pagina']), iPts=idx(['Puntos']);
  const iAtr=idx(['Atraso (d√≠as)','Atraso','Retraso','Atraso_dias']);
  const iMom=idx(['Momento']), iNomT=idx(['NombreTrabajo','Nombre Trabajo','Nombre_trabajo']);
  const iOrgS=idx(['OrigenScan','Origen Scan']), iNot=idx(['Notas']);
  return rows.map(r=>{
    const fecha=String(r[iF]??'').trim(); const fo=String((iFO>=0?r[iFO]:'')??'').trim()||fecha;
    const atraso=(()=>{if(iAtr>=0 && r[iAtr]!=='' && r[iAtr]!=null) return +r[iAtr]||0;
      const d=new Date(fecha), o=new Date(fo); if(isNaN(+d)||isNaN(+o)) return 0; return Math.max(0, Math.round((d-o)/86400000));})();
    return {
      uidEntrega:String((iUIDE>=0?r[iUIDE]:'')??'').trim(), uidPreset:String((iUIDP>=0?r[iUIDP]:'')??'').trim(),
      fecha, fechaObjetivo:fo, hora:String((iH>=0?r[iH]:'')??'').trim(),
      id:String((iID>=0?r[iID]:'')??'').trim(), nombre:String((iN>=0?r[iN]:'')??'').trim(),
      materia:String((iM>=0?r[iM]:'')??'').trim(), numero:String((iNum>=0?r[iNum]:'')??'').trim(),
      origen:String((iOri>=0?r[iOri]:'')??'').trim(), pagina:String((iPag>=0?r[iPag]:'')??'').trim(),
      puntos:+((iPts>=0?r[iPts]:0)??0)||0, atrasoDias:atraso, momento:String((iMom>=0?r[iMom]:'')??'').trim(),
      nombreTrabajo:String((iNomT>=0?r[iNomT]:'')??'').trim(), origenScan:String((iOrgS>=0?r[iOrgS]:'')??'').trim(), notas:String((iNot>=0?r[iNot]:'')??'').trim()
    };
  });
}
function parsePresets(cols,rows){
  const idx=names=>idxOfAnyLoose(cols,names);
  const iUID=idx(['UID_PRESET','UID PRESET','UID Preset','uid_preset','uidpreset']);
  const iFO=idx(['Fecha objetivo','Fecha Objetivo','Fecha_objetivo']); const iMom=idx(['Momento']); const iMat=idx(['Materia']);
  const iNum=idx(['N¬∫ Trabajo','No. Trabajo','N¬∫','No','Numero','N√∫mero','NumTrabajo']); const iOri=idx(['Origen']); const iPag=idx(['P√°gina','Pagina']);
  const iNom=idx(['NombreTrabajo','Nombre Trabajo','Nombre_trabajo']);
  return rows.map(r=>({ uid:String((iUID>=0?r[iUID]:'')??'').trim(), fechaObjetivo:String((iFO>=0?r[iFO]:'')??'').trim(), momento:String((iMom>=0?r[iMom]:'')??'').trim(),
    materia:String((iMat>=0?r[iMat]:'')??'').trim(), numero:String((iNum>=0?r[iNum]:'')??'').trim(), origen:String((iOri>=0?r[iOri]:'')??'').trim(),
    pagina:String((iPag>=0?r[iPag]:'')??'').trim(), nombreTrabajo:String((iNom>=0?r[iNom]:'')??'').trim() })).filter(p=>p.uid);
}
async function loadAsistenciaResumen(sheetId,cfg,alumnoRef){
  const ref=(typeof alumnoRef==='object'&&alumnoRef)?alumnoRef:{id:alumnoRef,nombre:''};
  try{
    const {cols,rows}=await loadSheetBlock(sheetId,'asistencia',cfg);
    const iId=findIdColumn(cols,rows); const iNom=idxOfAnyLoose(cols,['Nombre','Nombre del alumno','Alumno','Apellidos y Nombres','Nombre y Apellido']);
    let row=null;
    if(iId>=0 && ref.id){ row=rows.find(r=>normText(r[iId])===normText(ref.id)); }
    if(!row && iNom>=0 && ref.nombre){ row=rows.find(r=>normText(r[iNom])===normText(ref.nombre)); }
    if(!row) return {asistencias:0,faltas:0,total:0};
    const dateCols=getDateColumns(cols);
    let presentes=0,total=0;
    for(const i of dateCols){ const v=row[i]; if(v!==null && v!==''){ total++; if(isPresent(v)) presentes++; } }
    return {asistencias:presentes, faltas:Math.max(0,total-presentes), total};
  }catch{ return {asistencias:0,faltas:0,total:0}; }
}
function renderTrabajoItem(t){
  const fecha=normDate(t.fechaObjetivo)||t.fechaObjetivo||''; const nombreT=t.nombreTrabajo?` ¬∑ <i>${t.nombreTrabajo}</i>`:'';
  return `<details><summary><b>${t.materia||'‚Äì'}</b> ‚Äî ${t.numero||'‚Äì'} (${t.origen||'‚Äì'}${t.pagina?' ¬∑ p.'+t.pagina:''})${nombreT}${fecha?' ¬∑ '+fecha:''}</summary>
  <div class="hint">Momento: ${t.momento||'‚Äì'} ¬∑ UID: <span class="mono">${t.uid||'(s/uid)'}</span></div></details>`;
}
async function openStudent(sheetId,cfg,alumno){
  $('student-title').textContent=`${alumno.nombre} ‚Äî ${alumno.id||''}`;
  $('student-meta').textContent='Cargando‚Ä¶';
  setHTML('resume-pills',''); setHTML('faltantes',''); setHTML('tarde',''); setHTML('atiempo','');
  $('back-to-group').onclick=e=>{e.preventDefault();show('view-group');};
  show('view-student');
  try{
    let reg={cols:[],rows:[]}; try{reg=await loadSheetBlock(sheetId,'registro',cfg);}catch(e){}
    let entregas=parseRegistro(reg.cols,reg.rows);
    let list=entregas.filter(t=>normText(t.id)===normText(alumno.id));
    if(!list.length && alumno.nombre){ list=entregas.filter(t=>normText(t.nombre)===normText(alumno.nombre)); }
    entregas=list;

    let pres={cols:[],rows:[]}; try{pres=await loadSheetBlock(sheetId,'presets',cfg);}catch(e){}
    const presets=parsePresets(pres.cols,pres.rows);

    const entregasPorUID=new Map(); const clavesEntregas=new Map();
    for(const t of entregas){ if(t.uidPreset) entregasPorUID.set(t.uidPreset,t); else clavesEntregas.set(claveNoUID(t),t); }

    const faltantes=[], aTiempo=[], tarde=[];
    if(presets.length){ for(const p of presets){
      let ent=entregasPorUID.get(p.uid);
      if(!ent){ const k=[normText(p.materia||''),normTrabajo(p.numero||''),normText(p.origen||''),normPagina(p.pagina||''),normDate(p.fechaObjetivo||'')].join('|'); ent=clavesEntregas.get(k); }
      if(ent){(ent.atrasoDias>0?tarde:aTiempo).push({...p});} else {faltantes.push({...p});}
    } }

    const {asistencias,faltas,total}=await loadAsistenciaResumen(sheetId,cfg,{id:alumno.id,nombre:alumno.nombre});
    setHTML('resume-pills',`<span class="pill bad">Faltantes: ${faltantes.length}</span><span class="pill warn">Tarde: ${tarde.length}</span><span class="pill ok">A tiempo: ${aTiempo.length}</span><span class="pill">Asistencias: ${asistencias}/${total}</span>`);
    $('student-meta').textContent=`Hoja: ${sheetId}`;
    setHTML('faltantes', faltantes.length? faltantes.map(renderTrabajoItem).join('') : '<div class="empty">Sin faltantes (seg√∫n Presets).</div>');
    setHTML('tarde', tarde.length? tarde.map(renderTrabajoItem).join('') : '<div class="empty">Sin entregas tarde.</div>');
    setHTML('atiempo', aTiempo.length? aTiempo.map(renderTrabajoItem).join('') : '<div class="empty">Sin entregas a tiempo.</div>');
  }catch(e){
    $('student-meta').textContent='Error al cargar datos.';
    setHTML('faltantes',`<div class="empty">No se pudieron leer los datos.<br><span class="hint">${e.message}</span></div>`); setHTML('tarde',''); setHTML('atiempo','');
  }
}

/* ===== Diagn√≥stico ===== */
async function diagnoseSheet(sheetId,cfg){
  const tests=[
    {name:'Asistencia', fn:()=>loadSheetBlock(sheetId,'asistencia',cfg)},
    {name:'Registro de trabajos', fn:()=>loadSheetBlock(sheetId,'registro',cfg)},
    {name:'Presets', fn:()=>loadSheetBlock(sheetId,'presets',cfg)},
    {name:'Puntos (fallback alumnos)', fn:()=>loadSheetBlock(sheetId,'puntos',cfg)}
  ];
  let msg=`Diagn√≥stico de hoja ${sheetId}\n(usa GViz por nombre; si falla y hay GID, usa CSV)\n\n`;
  for(const t of tests){
    try{const {cols,rows}=await t.fn(); const head=cols.slice(0,8).join(' | '); msg+=`‚úî ${t.name}: ${cols.length} columnas, ${rows.length} filas\n    Encabezados: ${head}\n`;}
    catch(e){msg+=`‚úñ ${t.name}: ${e.message}\n`;}
  }
  alert(msg);
}

/* ===== INIT ===== */
loadCfg(); renderHome(); $('back-to-home').onclick=e=>{e.preventDefault(); show('view-home');};
</script>
</body>
</html>
